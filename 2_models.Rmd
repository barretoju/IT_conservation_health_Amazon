---
title: "Obj 2: Modelling Indgenous forests and landscape structure effects on fire-relted diseases"
author: "Julia Barreto, Filipa Palmeirin & Paula Prist"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    thumbnails: false
    lightbox: true
    gallery: false
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = F, message = F, warning = F, error= F)
# Load necessary libraries for data manipulation, modeling, visualization, and diagnostics
library(tidyr); library(dplyr)
library(skimr)
library(fitdistrplus)
library(GGally)      # Visualization of data relationships (e.g., ggpairs)
library(cowplot)     # Enhanced plotting themes, set default theme
theme_set(theme_cowplot())
library(mgcv)        # Generalized Additive Models (GAMs) for modeling
library(bbmle)       # Maximum likelihood estimation tools
library(DHARMa)      # Diagnostics for hierarchical (mixed) models
library(car)         # Companion to Applied Regression (diagnostics, collinearity)
library(broom)
library(ggeffects)   # Generate marginal effects and predictions from models
library(patchwork)   # Combine multiple ggplot plots
```


# Data Loading and Preprocessing

Load temporal health data and coordinates, merge and clean the datasets

```{r}
coord<- read.csv("data/raw/coordinates.csv", header = T) %>% dplyr::select(-FID)
data<- read.csv("data/processed/combined_data.csv", header = T)

fire.data <- data %>%
  dplyr::select(country, COD, year, fire_related, pop, IDH, for_PD, for_ED, for_AI,
                FS_PLAND, tot_IT, NOTackn_IT, acknlgd_IT, FS_noIT, pm25_SUM) %>%
  left_join(coord, by = "COD", relationship = "many-to-many") %>%
  # Removing NAs from the dataset
  drop_na(fire_related) %>%
  # Removing negative values of for_noIT from the dataset
  filter(FS_noIT > 0.00) %>%
  # fire variables
  dplyr::rename("fire.cases"= fire_related) %>%
  mutate(fire.incidence= (fire.cases * pop)/100000)
```

# Data Overview and Distributions

## Summary statistics and structure for dataset
```{r}
(sk <- skim(fire.data))
```

## Visualize the distribution of the response variables

### Number of cases of fire-related diseases
Examine distribution of fire cases
```{r}
hist(fire.data$fire.cases); descdist(fire.data$fire.cases, discrete= TRUE) # 
```

### Log-transformation of fire-related diseases cases
 (~normal)
```{r}
hist(log10(fire.data$fire.cases + 1)); descdist(log10(fire.data$fire.cases + 1), discrete = TRUE)
```

### Incicence of fire-related diseases
Examine distribution of fire incidence
```{r}
hist(fire.data$fire.incidence); descdist(fire.data$fire.incidence, discrete= FALSE)
```

### Log-transformation of fire-related diseases incidence
 (~gamma)
```{r}
hist(log10(fire.data$fire.incidence + 1)); descdist(log10(fire.data$fire.incidence + 1), discrete = FALSE)
```


# Predictor Correlations and Visualization

Plot pairwise relationships between predictors, focusing on key predictors
```{r}
# Custom function to visualize binned correlations
my_bin <- function(data, mapping, ..., low = "#132B43", high = "#56B1F7") {
  ggplot(data = data, mapping = mapping) +
    geom_bin2d(...) +  # Binned 2D histogram
    scale_fill_gradient(low = low, high = high) # Custom color gradient
}

ggpairs(
  fire.data,
  columns = c("tot_IT", "FS_PLAND", "FS_noIT", "for_ED", "for_AI", "for_PD"),
  lower = list(
    combo = wrap("facethist", binwidth = 1),  # Use faceted histograms for lower panels
    continuous = wrap(my_bin, binwidth = c(5, 0.5), high = "red")  # Customized binned 2D histograms
  )
)

# # Examine correlation coefficients between key variables to identify multicollinearity
# cor(fire.data$tot_IT, fire.data$FS_noIT)
# cor(fire.data$tot_IT, fire.data$for_ED)
# cor(fire.data$tot_IT, fire.data$for_AI)
# cor(fire.data$tot_IT, fire.data$for_PD)
# cor(poly(fire.data$tot_IT), fire.data$FS_PLAND) # Example of using polynomial terms
# 
# cor(poly(fire.data$FS_PLAND), fire.data$for_ED) # 0.2253946
# cor(poly(fire.data$FS_PLAND), fire.data$for_AI) # 0.715645
# cor(poly(fire.data$FS_PLAND), fire.data$for_PD) # 0.2195011
# cor(poly(fire.data$FS_PLAND), fire.data$for_ED) # Example of using polynomial terms
# 
# cor(poly(fire.data$FS_noIT), fire.data$for_ED) # 0.02567527
# cor(poly(fire.data$FS_noIT), fire.data$for_AI) # 0.6303039
# cor(poly(fire.data$FS_noIT), fire.data$for_PD) # 0.3686856
# cor(poly(fire.data$FS_noIT), fire.data$for_ED) # Example of using polynomial terms
# 
# cor(fire.data$for_ED, fire.data$for_PD) # 0.71855
# cor(fire.data$for_ED, fire.data$for_AI) # 0.3934413
# cor(fire.data$for_PD, fire.data$for_AI) # 0.06931937

```


# Model Fitting and Selection

## Explore a global model with multiple predictors and interactions
Perform model selection using dredge function to rank models based on AIC
```{r}
mglob <- gam(log10(fire.incidence + 2) ~ #scale(tot_IT) + scale(FS_PLAND) + scale(FS_noIT) + 
               poly(scale(tot_IT), 2) * poly(scale(FS_noIT, 2)) +
               scale(for_ED) + scale(for_PD) +
               offset(IDH) + s(year, bs = "re") + s(X,Y),
             family = Gamma(link = "log"), data = fire.data, na.action = "na.fail")
```


```{r, eval= FALSE}
library(MuMIn)
all_models <- dredge(mglob, rank = "AIC")
head(all_models)
```

## Check gam model and concurvity (analogous to multicollinearity in linear models)

This checks how well each predictor (or smooth term) can be predicted by the other predictors. A concurvity value close to 1 indicates high redundancy, suggesting collinearity among terms.

Reference: Concurvity assessment is based on Noam Ross's "GAMs in R" tutorial, Chapter 2, Section 10 "If the concurvity value is above 0.8, it is recommended to inspect the model more carefully for potential redundancy issues."

```{r}
concurvity(mglob, full = FALSE)
```

This function checks for possible issues with the model, including residual patterns, quantile plots, and other diagnostics.
```{r}
# Perform model diagnostics using gam.check
gam.check(mglob)
```

Still, vif calculation with GAMs are not straightforward, besides even harder interpretation when using polynomial terms, so we will refit to test in regular glmms. 

### Refitting Simplified Models and Generating Predictions
```{r}
mglm <- gam(log10(fire.incidence + 2) ~ scale(FS_noIT) + I(scale(FS_noIT)^2) +
                           (scale(tot_IT) + I(scale(tot_IT)^2)) * scale(for_PD) +
                           offset(IDH) + s(year, bs = "re") + s(X, Y),
                         family = Gamma(link = "log"), data = fire.data)
vif(mglm)
```


# Modelling

Generally, we build GAM spatial models contain random effects for year and geographical coordinates. For fire related diseases incidence we use gamma family of distribution and log link function.

## Absence of effect (aka Baseline Model, 'null')
Fit a model of absence of effect with only an intercept and random effects for year and spatial coordinates. This model serves as a baseline to compare against models with predictors. 

```{r}
mfire0 <- gam(log10(fire.incidence + 2) ~ 1 + 
                offset(IDH) + s(year, bs = "re") + s(X, Y),  
              family = Gamma(link = "log"),
              data = fire.data) 
# summary(mfire0) ; AIC(mfire0)
```

## Single-Predictor Models

Fit models with single predictors for different landscape variables and Indigenous Territories. Here, we first test both linear and polynomial (quadratic) terms to determine which is more parsimonious.

```{r}
# Model for forest cover within the entire COD/municipality (FS_PLAND)
# Linear model for FS_PLAND (commented out as it was not selected)
# mfire_FS <- gam(log10(fire.incidence + 2) ~ scale(FS_PLAND) + offset(IDH) + s(year, bs = "re") + s(X,Y), family= Gamma(link = "log"), data = fire.data)

# Polynomial model (second degree) for FS_PLAND
mfire_FS2 <- gam(log10(fire.incidence + 2) ~ poly(scale(FS_PLAND), 2) +
                   offset(IDH) + s(year, bs = "re") + s(X, Y),
                 family = Gamma(link = "log"), data = fire.data)
# summary(mfire_FS2); AIC(mfire_FS2)  # Display summary and AIC for the polynomial model

# Model for Indigenous Territories (tot_IT)
# Linear model for tot_IT (commented out as it was not selected)
# mfire_IT <- gam(log10(fire.incidence + 2) ~ scale(tot_IT) + offset(IDH) + s(year, bs = "re") + s(X,Y), family= Gamma(link = "log"), data = fire.data)

# Polynomial model (second degree) for tot_IT
mfire_IT2 <- gam(log10(fire.incidence + 2) ~ poly(scale(tot_IT), 2) +
                   offset(IDH) + s(year, bs = "re") + s(X, Y),
                 family = Gamma(link = "log"), data = fire.data)
# summary(mfire_IT2); AIC(mfire_IT2)  # Display summary and AIC for the polynomial model

# Model for forest cover outside Indigenous Territories (FS_noIT)
# Linear model for FS_noIT (commented out as it was not selected)
# mfire_FSnoIT <- gam(log10(fire.incidence + 2) ~ scale(FS_noIT) + offset(IDH) + s(year, bs = "re") + s(X,Y), family= Gamma(link = "log"), data = fire.data)

# Polynomial model (second degree) for FS_noIT
mfire_FSnoIT2 <- gam(log10(fire.incidence + 2) ~ poly(scale(FS_noIT), 2) +
                      offset(IDH) + s(year, bs = "re") + s(X, Y),
                    family = Gamma(link = "log"), data = fire.data)
# summary(mfire_FSnoIT2); AIC(mfire_FSnoIT2)  # Display summary and AIC for the polynomial model
```

## Additive Models with Multiple Predictors

Build additive models combining Indigenous Territories (tot_IT) and forest cover outside Indigenous Territories (FS_noIT)
```{r}
# Additive model with polynomial terms for tot_IT and FS_noIT
mfire_ITFSno <- gam(log10(fire.incidence + 2) ~ 
                      poly(scale(tot_IT), 2) + poly(scale(FS_noIT), 2) +
                      offset(IDH) + s(year, bs = "re") + s(X, Y),
                    family = Gamma(link = "log"), data = fire.data)
# summary(mfire_ITFSno); AIC(mfire_ITFSno)  # Display summary and AIC for the model

# Interactive models to explore interactions between predictors
mfire_ITFSno1i <- gam(log10(fire.incidence + 2) ~ 
                       poly(scale(tot_IT), 2) * scale(FS_noIT) +
                       offset(IDH) + s(year, bs = "re") + s(X, Y),
                     family = Gamma(link = "log"), data = fire.data)
# summary(mfire_ITFSno1i); AIC(mfire_ITFSno1i)  # Display summary and AIC for interaction model
```

## Interactive Models with Multiple Predictors
```{r}
# interativos IT * forest (FS_noIT)
mfire_ITFSno1i <- gam(log10(fire.incidence + 2) ~ 
                       poly(scale(tot_IT),2) * scale(FS_noIT) +
                      offset(IDH) + s(year, bs = "re") + s(X,Y),
                    family= Gamma(link = "log"), data = fire.data)
# summary(mfire_ITFSno1i); AIC(mfire_ITFSno1i) #  24290.42

mfire_IT1FSnoi <- gam(log10(fire.incidence + 2) ~ 
                       scale(tot_IT) * poly(scale(FS_noIT, 2)) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_IT1FSnoi); AIC(mfire_IT1FSnoi) #  24308.9
```

## Introduct fragmentation effect

### Single-Predictor Models for Landscape Configuration Variables (e.g., for_ED and for_PD)

```{r}
# Model for forest edge density (for_ED)
mfire_ED <- gam(log10(fire.incidence + 2) ~ scale(for_ED) +
                    offset(IDH) + s(year, bs = "re") + s(X, Y),
                  family = Gamma(link = "log"), data = fire.data)
# summary(mfire_ED); AIC(mfire_ED)  # Display summary and AIC for for_ED model

# Model for patch density (for_PD)
mfire_PD <- gam(log10(fire.incidence + 2) ~ scale(for_PD) +
                    offset(IDH) + s(year, bs = "re") + s(X, Y),
                  family = Gamma(link = "log"), data = fire.data)
# summary(mfire_PD); AIC(mfire_PD)  # Display summary and AIC for for_PD model
```

### Landscape structure: forest cover and frag
Build models combining landscape cover (FS_PLAND) and configuration (for_ED and for_PD)

```{r}
# Additive model combining FS_PLAND and for_ED
mfire_FSED <- gam(log10(fire.incidence + 2) ~ poly(scale(FS_PLAND), 2) + scale(for_ED) +
                       offset(IDH) + s(year, bs = "re") + s(X, Y),
                     family = Gamma(link = "log"), data = fire.data)
# summary(mfire_FSED); AIC(mfire_FSED)  # Display summary and AIC for the model

# Additive model combining FS_PLAND and for_PD
mfire_FSPD <- gam(log10(fire.incidence + 2) ~ poly(scale(FS_PLAND), 2) + scale(for_PD) +
                       offset(IDH) + s(year, bs = "re") + s(X, Y),
                     family = Gamma(link = "log"), data = fire.data)
# summary(mfire_FSPD); AIC(mfire_FSPD)  # Display summary and AIC for the model
```

### ITs and configuration
```{r}
mfire_TIED <- gam(log10(fire.incidence + 2) ~ poly(scale(tot_IT),2) + scale(for_ED) +
                  offset(IDH) + s(year, bs = "re") + s(X,Y),
                family= Gamma(link = "log"), data = fire.data)
# summary(mfire_TIED); AIC(mfire_TIED) #  24272.48

mfire_TIPD <- gam(log10(fire.incidence + 2) ~ poly(scale(tot_IT),2) + scale(for_PD) +
                  offset(IDH) + s(year, bs = "re") + s(X,Y),
                family= Gamma(link = "log"), data = fire.data)
# summary(mfire_TIPD); AIC(mfire_TIPD) #  24118.99
```

### Tripple additives IT + forests + frags
```{r}
mfire_ITFSED <- gam(log10(fire.incidence + 2) ~ poly(scale(tot_IT),2) + 
                         poly(scale(FS_noIT),2) + scale(for_ED) +
                         offset(IDH) + s(year, bs = "re") + s(X,Y),
                       family= Gamma(link = "log"), data = fire.data)
# summary(mfire_ITFSED); AIC(mfire_ITFSED) #  24083.9

mfire_ITFSPD <- gam(log10(fire.incidence + 2) ~ poly(scale(tot_IT),2) + 
                         poly(scale(FS_noIT),2) + scale(for_PD) +
                         offset(IDH) + s(year, bs = "re") + s(X,Y),
                       family= Gamma(link = "log"), data = fire.data)
# summary(mfire_ITFSPD); AIC(mfire_ITFSPD) #  23942.26
```

### Interactive doubles
```{r}
    ## interactive landscape structure
mfire_FSEDi <- gam(log10(fire.incidence + 2) ~ 
                     poly(scale(FS_PLAND),2) * scale(for_ED) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_FSEDi); AIC(mfire_FSEDi) #  24040.44

mfire_FSPDi <- gam(log10(fire.incidence + 2) ~ 
                        poly(scale(FS_PLAND),2) * scale(for_PD) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_FSPDi); AIC(mfire_FSPDi) #  23958.51
```

#### 2x Interactive TI frags
```{r}
mfire_TIEDi <- gam(log10(fire.incidence + 2) ~ 
                     poly(scale(tot_IT),2) * scale(for_ED) +
                    offset(IDH) + s(year, bs = "re") + s(X,Y),
                  family= Gamma(link = "log"), data = fire.data)
# summary(mfire_TIEDi); AIC(mfire_TIEDi) #  24230.41

mfire_TIPDi <- gam(log10(fire.incidence + 2) ~ 
                     poly(scale(tot_IT),2) * scale(for_PD) +
                    offset(IDH) + s(year, bs = "re") + s(X,Y),
                  family= Gamma(link = "log"), data = fire.data)
# summary(mfire_TIPDi); AIC(mfire_TIPDi) #  24092.69
```

### 2x Interactive + singel terms: 

#### IT + interactive landscape structure
```{r}
mfire_ITiFSED <- gam(log10(fire.incidence + 2) ~ poly(scale(tot_IT),2) + 
                      poly(scale(FS_noIT),2) * scale(for_ED) +
                      offset(IDH) + s(year, bs = "re") + s(X,Y),
                    family= Gamma(link = "log"), data = fire.data)
# summary(mfire_ITiFSED); AIC(mfire_ITiFSED) #  24068.79

mfire_ITiFSPD <- gam(log10(fire.incidence + 2) ~ poly(scale(tot_IT),2) + 
                      poly(scale(FS_noIT),2) * scale(for_PD) +
                      offset(IDH) + s(year, bs = "re") + s(X,Y),
                    family= Gamma(link = "log"), data = fire.data)
# summary(mfire_ITiFSPD); AIC(mfire_ITiFSPD) #  23927.62
```

#### Landscape cover + interactive IT * landscape configuration

```{r}
mfire_FSiTIED <- gam(log10(fire.incidence + 2) ~ poly(scale(FS_noIT),2) + 
                       poly(scale(tot_IT),2) * scale(for_ED) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_FSiTIED); AIC(mfire_FSiTIED) #  23981.11

mfire_FSiTIPD <- gam(log10(fire.incidence + 2) ~ poly(scale(FS_noIT),2) + 
                       poly(scale(tot_IT),2) * scale(for_PD) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_FSiTIPD); AIC(mfire_FSiTIPD) #  23895.59
```

#### Landscape configuration + interactive IT * landscape cover
```{r}
mfire_EDiFSTI1 <- gam(log10(fire.incidence + 2) ~ poly(scale(FS_noIT),2) *scale(tot_IT) +
                       scale(for_ED) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_EDiFSTI1); AIC(mfire_EDiFSTI1) #  240048.01

mfire_EDiFS1TI <- gam(log10(fire.incidence + 2) ~ scale(FS_noIT) *poly(scale(tot_IT),2) +
                       scale(for_ED) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_EDiFS1TI); AIC(mfire_EDiFS1TI) #  24249.01

mfire_PDiFSTI1 <- gam(log10(fire.incidence + 2) ~ poly(scale(FS_noIT),2) * scale(tot_IT) +
                       scale(for_PD) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_PDiFSTI1); AIC(mfire_PDiFSTI1) #  23910.84

mfire_PDiFS1TI <- gam(log10(fire.incidence + 2) ~ scale(FS_noIT) * poly(scale(tot_IT),2) +
                       scale(for_PD) +
                       offset(IDH) + s(year, bs = "re") + s(X,Y),
                     family= Gamma(link = "log"), data = fire.data)
# summary(mfire_PDiFS1TI); AIC(mfire_PDiFS1TI) #  24105.58
```

<!-- ## Tipple interaction -->
<!-- ```{r} -->

<!-- # ## tipple interactive: IT * forests * frags (over complicated) -->
<!-- # mfire_ITFSEDi <- gam(log10(fire.incidence + 2) ~  -->
<!-- #                           poly(scale(tot_IT),2) * poly(scale(FS_noIT),2) * scale(for_ED) + -->
<!-- #                          offset(IDH) + s(year, bs = "re") + s(X,Y), -->
<!-- #                        family= Gamma(link = "log"), data = fire.data) -->
<!-- # # summary(mfire_ITFSEDi); AIC(mfire_ITFSEDi) #  23809.09 -->
<!-- #  -->
<!-- # mfire_ITFSPDi <- gam(log10(fire.incidence + 2) ~  -->
<!-- #                           poly(scale(tot_IT),2) * poly(scale(FS_noIT),2) * scale(for_PD) + -->
<!-- #                          offset(IDH) + s(year, bs = "re") + s(X,Y), -->
<!-- #                        family= Gamma(link = "log"), data = fire.data) -->
<!-- # # summary(mfire_ITFSPDi); AIC(mfire_ITFSPDi) #  23653.74 -->

<!-- ``` -->

# Model Selection Using AIC Comparison
Perform model selection by comparing all models based on AIC using AICtab function
```{r}
(mod.sel <- AICtab(mfire0,
       # FSs
       mfire_FS2,
        # ITs
       mfire_IT2,
       # FSs outside IT
       mfire_FSnoIT2, 
       # additives IT + forest (PLAND and FS_noIT)
       mfire_ITFSno,
       # interativos IT * forest (FS_noIT)
       mfire_IT1FSnoi,
       mfire_ITFSno1i,
       # frags solitos
       mfire_ED, mfire_PD,
       # landscape structure: forest cover and frag
       mfire_FSED, mfire_FSPD,
       # additive TI frags
       mfire_TIED, mfire_TIPD,
       # interactive doubles
       mfire_FSEDi, mfire_FSPDi, ## interactive landscape structure
       mfire_TIEDi, mfire_TIPDi,## interactive TI frags
       ## tipple additives IT + forests + frags
       mfire_ITFSED, mfire_ITFSPD,
       # triple terms aad + interactive: 
       mfire_ITiFSED, mfire_ITiFSPD, # IT + interactive landscape structure
       mfire_FSiTIED, mfire_FSiTIPD, # cover + IT*frag
       mfire_EDiFSTI1, mfire_EDiFS1TI, mfire_PDiFSTI1, mfire_PDiFS1TI, # frag + cover*TI
       ## tipple interactive: IT * forests * frags
       # mfire_ITFSEDi, mfire_ITFSPDi,
       base = TRUE, weights = TRUE))  # Include null model and calculate weights
```
# Top selected model output

Summarize the selected model to examine the fitted results
```{r}
summary(mfire_FSiTIPD)
```

Tidy up the model summary to get a clean output of the parametric terms
```{r}
tidy(mfire_FSiTIPD, parametric = TRUE)  #
```

# Model Diagnostics

## Concurvity

Check analogous to multicollinearity in linear models tests
```{r}
concurvity(mfire_FSiTIPD, full = FALSE)
```

## Model check

Run additional diagnostic checks for model assumptions using gam.check()
```{r}
gam.check(mfire_FSiTIPD)  
```

## Overdispersion

Test for overdispersion in the residuals using DHARMa's testDispersion()
```{r}
DHARMa::testDispersion(mfire_FSiTIPD)
``` 

## Test and plot residuals

Generate residual diagnostic plots to visually inspect residuals and validate model assumptions. Creates diagnostic plots such as residual vs. fitted plots, QQ plots, and others for more in-depth inspection.
```{r}
testResiduals(mfire_FSiTIPD, plot = TRUE)
```

# Prediction plot

We originally use orthogonal polynomials (i.e. `poly(predictor_ _variable, 2)`) for model selection due to their statistical advantages, which often leads to more reliable statistical inference. So model selection was based on orthogonal polynomials (`poly(x, 2)`) for robustness, but for practical visualization purpose, we use regular quadratic terms (`I(x^2)`) for clarity. The overall predicted trends (i.e., the shapes of the response curves) produced by a model using orthogonal polynomials (`poly(x, 2)`) and regular quadratic terms (`I(x^2)`) are generally comparable. Both models capture the quadratic relationships in the data.

```{r}
mfire_FSiTIPD_quad <- gam(log10(fire.incidence + 2) ~ 
                            scale(FS_noIT) + I(scale(FS_noIT)^2) + 
                            (scale(tot_IT) + I(scale(tot_IT)^2)) * scale(for_PD) +
    offset(IDH) + s(year, bs = "re") + s(X, Y), 
  family = Gamma(link = "log"), data = fire.data)
```

Plot predicted effects of Indigenous Territories (tot_IT) on fire incidence at different levels of patch density (for_PD)
```{r}
# Generate predictions for the fitted model at different levels of predictors. Predictions are made for a range of values for each predictor; 'all' indicates the full range.
preds <- ggpredict(mfire_FSiTIPD_quad, terms = c("tot_IT [all]", "for_PD", "FS_noIT"))  

ggplot(preds, aes(x = x, y = predicted, color = group)) +
  geom_line(linewidth = 1) +  # Plot prediction lines
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +  # Add confidence intervals as ribbons
  labs(
    title = "Predicted Effect of IT ~ PD, on low, median and hight FS cover",
    x = "IT percent",
    y = "Predicted Fire Incidence",
    color = "PD Levels",
    fill = "PD Levels"
  ) +
  scale_color_manual(values = c("#00441b", "#238b45", "#66c2a4")) + 
  scale_fill_manual(values = c("#00441b", "#238b45", "#66c2a4")) +
  facet_wrap(~facet)  # Facet plot by the 'facet' variable to display different groups
```

## Visualize Two-by-Two Interactions
IT and PD
```{r}
# Generate predictions for interactions between tot_IT and for_PD
preds_TI_PD <- ggpredict(mfire_FSiTIPD_quad, terms = c("tot_IT [all]", "for_PD"))  
# Plot predicted effects for IT on Fire Incidence at different levels of PD
(plot_TI_PD <- ggplot(preds_TI_PD, aes(x = x, y = predicted, color = group)) +
    geom_line(linewidth = 1) + 
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    labs(
      title = "Predicted Effect of IT on Fire Incidence at Different Levels of PD",
      x = "IT percent",
      y = "Predicted Fire Incidence",
      color = "PD Levels",
      fill = "PD Levels"
    ) +
  scale_color_manual(values = c("#00441b", "#238b45", "#66c2a4")) +
  scale_fill_manual(values = c("#00441b", "#238b45", "#66c2a4")))
```

IT and FS cover
```{r}
# Generate predictions for interactions between tot_IT and FS_noIT
preds_TI_FS <- ggpredict(mfire_FSiTIPD_quad, terms = c("tot_IT [all]", "FS_noIT"))

# Plot predicted effects for IT on Fire Incidence at different levels of FS_noIT
(plot_TI_FS <- ggplot(preds_TI_FS, aes(x = x, y = predicted, color = group)) +
    geom_line(linewidth = 1) + 
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.2) +
    labs(
      title = "Predicted Effect of IT on Fire Incidence at Different Levels of FS",
      x = "IT percent",
      y = "Predicted Fire Incidence",
      color = "FS cover",
      fill = "FS cover"
    ) +
  scale_color_manual(values = c("#66c2a4", "#238b45", "#00441b")) +
  scale_fill_manual(values = c("#66c2a4", "#238b45", "#00441b")))
```


## Plot Individual Predictor Effects
```{r, fig.width=12, fig.height= 6}
# Generate and plot predictions for single predictors
preds_PD <- ggpredict(mfire_FSiTIPD_quad, terms = "for_PD")  # Predictions for PD

# Plot for PD
plot_PD <- ggplot(preds_PD, aes(x = x, y = predicted)) +
    geom_line(linewidth = 1) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
    labs(
      x = "Patch density",
      y = "Predicted Fire Incidence")

# Generate and plot predictions for tot_IT
preds_IT <- ggpredict(mfire_FSiTIPD_quad, terms = "tot_IT")  # Predictions for PD
plot_IT <- ggplot(preds_IT, aes(x = x, y = predicted)) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = 0.2) +
  labs(
    x = "Extent of indigenous territories",
    y = "Predicted Fire Incidence"
  )

# Combine plots side by side using patchwork
(combined_plot <- plot_IT + plot_PD)  # Combine IT and PD plots for side-by-side comparison
```

