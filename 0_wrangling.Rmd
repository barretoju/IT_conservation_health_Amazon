---
title: "Wrangling and organizing health, socio-economic and environmental data for the Amazon project"
author: "Julia Barreto"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    thumbnails: false
    lightbox: true
    gallery: false
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = F, message = F, warning = F, error= F)
library(here)
library(sf)
library(tidyverse)
library(kableExtra)
# library(readxl)
library(tibble)
# library(ggplot2)
# library(patchwork)
# library(sf)
# library(mapview)
# library(janitor)
```


## Panamazon spatial data

Load Amazon municipalities boundaries (shapefile) identified as COD, to be base of all data entry.

```{r}
our_amazon <- st_read(here("data", "raw", "amazon_districts_ALBERS.shp")) %>%
  #treat guiana francesa COD that contaisn . and _
  mutate(COD= gsub("[._]", "", COD)) 
# plot(our_amazon %>% filter(!is.na(COD)))
our_amazon <- our_amazon %>% 
  as.data.frame() %>%
  # Keep only unique COD (e.g. SR = country-level Surinamese data)
  distinct(COD, .keep_all = TRUE) 
```

# Health data

## Load
Yearly health data per country at each provided geographic level (COD), e.g. municipality.

```{r}
master_health <- read.csv(here("data", "raw", "master_health.csv"))

knitr::kable(master_health %>% 
  sample_n(30) %>% 
  print(row.names = FALSE), booktabs = TRUE) %>%
kable_styling(latex_options = "scale_down") %>%
  column_spec(1:ncol(master_health), width = "auto")
```


```{r, echo= FALSE}
combined_data <- our_amazon %>% 
  dplyr::select(-geometry) %>% arrange(COD) %>%
  left_join(master_health, by= "COD")
```


## Cleaning and Subsetting

Data wrangling to remove rows based on health, temporal and spatial data availability and reliability.

    - Remove years >=2020: We decided to exclude the years of the COVID-19 pandemic, 2020 and 2021, to avoid any confounding factors. 
      - Remove years < 2001: No mapping for the amazon, to calculate fire effects, for less than 2001.
      - Remove CODs with no health data (country id from master health)

```{r}
combined_data <- combined_data %>% 
  filter(year< 2020,
         year >= 2001) %>%
  drop_na(country)
```

From a total of `r dim(our_amazon)[1]` amazonian municipalities, we were able to gather temporal health data for `r length(unique(combined_data$COD))`, which represents `r paste0(round(length(unique(combined_data$COD[!is.na(combined_data$health)]))*100/length(unique(our_amazon$COD)),1), "%")` of the Amazon.

# Socio-environmental

## Population

```{r}
pop_data <- read.csv(here("data", "raw", "pop.csv"))

combined_data <- combined_data %>%
  left_join(pop_data, by= c( "COD", "year"))

knitr::kable(pop_data %>% 
  sample_n(30) %>% 
  print(row.names = FALSE), booktabs = TRUE) %>%
kable_styling(latex_options = "scale_down") %>%
  column_spec(1:ncol(pop_data), width = "auto")
```

## Human Development Index (IDH)

Data from 1990-2022 for of mean country subnational Human Development Index (sHDI).

```{r}
idh_data <- read.csv(here("data", "raw", "idh.csv"))

combined_data <- combined_data %>%
  left_join(idh_data, by= c("country", "year"))

knitr::kable(idh_data %>% 
  sample_n(30) %>% 
  print(row.names = FALSE), booktabs = TRUE) %>%
kable_styling(latex_options = "scale_down") %>%
  column_spec(1:ncol(idh_data), width = "auto")
```

# Landscape data

Data extracted on ArcGIS and fragstats on forest cover and configuration for each municipality 


```{r}
frag_data <- read.csv(here("data", "raw", "frag_all.csv"))

combined_data <- combined_data %>%
  left_join(frag_data, by= c("COD", "year")) 
```

# Indigenous territories

Indigenous territories percent per COD.
```{r}
tis_data <- read.csv(here("data", "raw", "IT_data.csv")) %>%
  mutate(IT_presence = ifelse(tot_IT > 0, "yes_IT", "no_IT"),
    IT_acknlgd = case_when(
      acknlgd_IT > 0 & NOTackn_IT == 0 ~ "acknowledged_only",
      NOTackn_IT > 0 & acknlgd_IT == 0 ~ "not_acknowledged",
      NOTackn_IT > 0 & acknlgd_IT > 0  ~ "both",
      TRUE ~ "none"))

# Visualizando as novas colunas criadas
head(tis_data)


combined_data <- combined_data %>%
  left_join(tis_data, by= "COD")
```

From forest/savanna cover,and percentage of ITs, we then calculate the metrics of landscape structure: (1) percentage of forest and savanna cover *outside* indigenous territories (*FS_notIT*), (2) percentage of forest cover and/or savanna *within recognized* indigenous territories (*ackn_IT*) , (3) percentage of forest cover and/or savanna *within unrecognized* indigenous territories (*NOTackn_IT*), (4) total percentage of forest cover and/or savanna *within indigenous territories* (considering both recognized and unrecognized; *tot_IT*) and (5) *total percentage of forest and/or savanna* cover (considering outside and inside indigenous territories; *FS_PLAND*). Also those of landscape configuration that refers to the degree of forest fragmentation, including edge density (*for_ED*), patchiness (*for_PD*), and the aggregation (*for_AI*) between those forest remnants (considering outside and inside indigenous territories). 

```{r, echo= FALSE}
combined_data <- combined_data %>% 
  mutate(FS_noIT = (for_PLAND + savanna_PLAND)- tot_IT,
         habitat_noIT = (for_PLAND + savanna_PLAND + notforest_PLAND)- tot_IT)

knitr::kable(combined_data %>% dplyr::select(1:3, 25:dim(combined_data)[2]) %>%
  sample_n(30) %>% 
  print(row.names = FALSE), 
             booktabs = TRUE) %>%
kable_styling(latex_options = "scale_down") %>%
  column_spec(1:17, width = "auto")
```

# Fire pollutants (PM2.5)

```{r}
pm25_data <- read.csv(here("data", "raw", "pm25_data.csv"))

combined_data <- combined_data %>%
  left_join(pm25_data, by= c("COD", "year"))
```


## Fire incidence


```{r}
fire_data <- read.csv(here("data", "raw", "fire_data.csv")) 

combined_data <- combined_data %>%
  left_join(fire_data, by= c("COD", "year")) %>%
  dplyr::select(country, everything())
```

# Full master data

```{r}
knitr::kable(combined_data %>% 
  sample_n(30) %>% 
  print(row.names = FALSE), booktabs = TRUE) %>%
kable_styling(latex_options = "scale_down") %>%
  column_spec(1:ncol(combined_data), width = "auto")
```


### Summarized data

Summarize data by country and year, and replace 0s with NA for common diseases (fire-related), and make sure zoonotics/vector-borne diseases are NA.

```{r, echo= FALSE}
summarized_data <- combined_data %>%
  select(1:22) %>%
  group_by(country, year) %>%
  mutate(
    sum_fire_related = sum(fire_related, na.rm = TRUE),
    sum_respiratory = sum(respiratory, na.rm = TRUE),
    sum_cardiovascular = sum(cardiovascular, na.rm = TRUE)) %>%
  mutate(
    fire_related = ifelse(sum_fire_related == 0, NA, fire_related),
    respiratory = ifelse(sum_respiratory == 0, NA, respiratory),
    cardiovascular = ifelse(sum_cardiovascular == 0, NA, cardiovascular)) %>%
  select(-sum_fire_related, -sum_respiratory, -sum_cardiovascular) %>%
  ungroup() %>%
  group_by(country, year, n_zoo, n_fire, n_resp, n_card, n_acute, n_chronic) %>%
  summarise(across(where(is.numeric), sum, na.rm = TRUE))

# for zoonotic:

# Malaria they all do, chagas not suriname and venezuela
summarized_data$chagas[summarized_data$country %in% c("Suriname", "Venezuela")] <- NA
summarized_data$chagas[summarized_data$country %in% c("Suriname", "Venezuela")] <- NA

# List of countries to set Hantavirus cases to NA
summarized_data$hantavirus[summarized_data$country %in% c("Bolivia", "Colombia", "Ecuador", "Suriname", "Venezuela")] <- NA
summarized_data$hantavirus[summarized_data$country %in% c("Bolivia", "Colombia", "Ecuador", "Suriname", "Venezuela")] <- NA

# Leishmaniasis cutanea
summarized_data$cutaneous_leishmaniasis[summarized_data$country %in% "Venezuela"] <- NA
summarized_data$cutaneous_leishmaniasis[summarized_data$country %in% "Venezuela"] <- NA

# visceral_leishmaniasis
summarized_data$visceral_leishmaniasis[summarized_data$country %in% c("Bolivia", "Colombia", "Guiana FR", "Peru", "Suriname", "Venezuela")] <- NA
summarized_data$visceral_leishmaniasis[summarized_data$country %in% c("Bolivia", "Colombia", "Guiana FR", "Peru", "Suriname", "Venezuela")] <- NA

# rickettsia
summarized_data$rickettsia[summarized_data$country %in% c("Brasil","Suriname", "Venezuela")] <- NA
summarized_data$rickettsia[summarized_data$country %in% c("Brasil", "Suriname", "Venezuela")] <- NA

# Raw data sums per region/year:
# Define the maximum limits for specific columns
max_limits <- list(
  n_zoo = 6,
  n_resp = 11,
  n_card = 4,
  n_fire = 15,
  n_acute = 9,
  n_chronic = 6
)

# Summarize total Amazon data per year, and replace 0s with NA for common diseases
amazon_total <- summarized_data %>%
  group_by(year) %>%
  summarise(across(where(is.numeric), sum, na.rm = TRUE)) %>%
  mutate(country = "Total Amazon") %>%
  select(country, everything()) %>%
  mutate(
    n_zoo = pmin(n_zoo, max_limits$n_zoo),
    n_resp = pmin(n_resp, max_limits$n_resp),
    n_card = pmin(n_card, max_limits$n_card),
    n_fire = pmin(n_fire, max_limits$n_fire),
    n_acute = pmin(n_acute, max_limits$n_acute),
    n_chronic = pmin(n_chronic, max_limits$n_chronic)
  )

# Combine the country data with the total Amazon data
combined_summarized_data <- bind_rows(amazon_total, summarized_data) %>%
  arrange(year, factor(country, levels = c("Total Amazon", sort(unique(summarized_data$country))))) %>%
  dplyr::select(country, year, health, chagas, hantavirus,
  cutaneous_leishmaniasis, visceral_leishmaniasis, rickettsia, 
  malaria, zoonotic, n_zoo, fire_related, n_fire, cardiovascular, n_card, 
  respiratory, n_resp, acute, n_acute, chronic, n_chronic)

# write.csv(combined_summarized_data, here("data", "combined_summarized_data.csv"))
print(combined_summarized_data)
```


*Treat zero data years as NAs per country/disease*

"In cases where fire-related diseases were zero for that country and year, we assumed it was not monitored and substituted zeros with NAs to avoid underestimation, as fire-related are common and normally have a high-incidence over the populations."

```{r}
combined_data <- combined_data %>%
  group_by(country, year) %>%
  mutate(
    sum_fire_related = sum(fire_related, na.rm = TRUE),
    sum_respiratory = sum(respiratory, na.rm = TRUE),
    sum_cardiovascular = sum(cardiovascular, na.rm = TRUE)
  ) %>%
  mutate(
    fire_related = ifelse(sum_fire_related == 0, NA, fire_related),
    respiratory = ifelse(sum_respiratory == 0, NA, respiratory),
    cardiovascular = ifelse(sum_cardiovascular == 0, NA, cardiovascular)
  ) %>%
  select(-sum_fire_related, -sum_respiratory, -sum_cardiovascular) %>%
  ungroup()

# for zoonotic, who does not monitor, make sure its NA:

# Malaria they all do, chagas not suriname and venezuela
combined_data$chagas[combined_data$country %in% c("Suriname", "Venezuela")] <- NA
summarized_data$chagas[summarized_data$country %in% c("Suriname", "Venezuela")] <- NA

# List of countries to set Hantavirus cases to NA
combined_data$hantavirus[combined_data$country %in% c("Bolivia", "Colombia", "Ecuador", "Suriname", "Venezuela")] <- NA
summarized_data$hantavirus[summarized_data$country %in% c("Bolivia", "Colombia", "Ecuador", "Suriname", "Venezuela")] <- NA

# Leishmaniasis cutanea
combined_data$cutaneous_leishmaniasis[combined_data$country %in% "Venezuela"] <- NA
summarized_data$cutaneous_leishmaniasis[summarized_data$country %in% "Venezuela"] <- NA

# visceral_leishmaniasis
combined_data$visceral_leishmaniasis[combined_data$country %in% c("Bolivia", "Colombia", "Guiana FR", "Peru", "Suriname", "Venezuela")] <- NA
summarized_data$visceral_leishmaniasis[summarized_data$country %in% c("Bolivia", "Colombia", "Guiana FR", "Peru", "Suriname", "Venezuela")] <- NA

# rickettsia
combined_data$rickettsia[combined_data$country %in% c("Brasil","Suriname", "Venezuela")] <- NA
summarized_data$rickettsia[summarized_data$country %in% c("Brasil", "Suriname", "Venezuela")] <- NA
```


# Save data
```{r}
write.csv(combined_data, 
          file=here::here("data", "processed","combined_data.csv"),
          row.names=FALSE)
```

Save dataset for each country:
```{r}
unique_countries <- unique(combined_data$country)

#  Loop para criar e salvar os subconjuntos
for (country in unique_countries) {
  # Filtrar o dataset pelo paÃ­s atual
  subset_data <- combined_data %>% filter(country == !!country)
  
  # Criar o nome do arquivo CSV
  file_name <- paste0("data/processed/", country, ".csv")
  
  # Salvar o subconjunto em um arquivo CSV
  write.csv(subset_data, file_name, row.names = FALSE)
}

```

# Metadata

```{r, echo= FALSE}
metadata <- tribble(
  ~Column_Name,                 ~Description,
  "country",                    "Country code (BO- Bolivia, BR- Brazil, CO- Colombia, etc)",
  "COD",                        "Specific identifier code for municipalities within the country",
  "year",                       "Year of the data entry",
  "health",                     "General health indicator",
  "chagas",                     "Number of reported cases of Chagas disease",
  "hantavirus",                 "Number of reported cases of Hantavirus",
  "cutaneous_leishmaniasis",    "Number of reported cases of cutaneous leishmaniasis",
  "visceral_leishmaniasis",     "Number of reported cases of visceral leishmaniasis",
  "rickettsia",                 "Number of reported cases of Rickettsia",
  "malaria",                    "Number of reported cases of Malaria",
  "zoonotic",                   "Number of reported zoonotic diseases",
  "n_zoo",                      "Number of zoonotic diseases",
  "fire_related",               "Number of reported cases of diseases related to fire",
  "n_fire",                     "Number of fire-related diseases",
  "acute",                      "Number of reported cases of acute diseases",
  "n_acute",                    "Number of acute diseases",
  "chronic",                    "Number of reported cases of chronic conditions",
  "n_chronic",                  "Number of chronic conditions",
  "respiratory",                "Number of reported cases of respiratory conditions",
  "n_resp",                     "Number of respiratory conditions",
  "cardiovascular",             "Number of reported cases of cardiovascular conditions",
  "n_card",                     "Number of cardiovascular conditions",
  "pop",                        "Population",
  "IDH",                        "Human Development Index",
  "for_PLAND",                  "Forest percentage land descriptor",
  "for_PD",                     "Patch density",
  "for_ED",                     "Forest edge density",
  "for_ENN_MN",                 "Forest mean Euclidean nearest neighbor distance",
  "for_AI",                     "Forest aggregation index",
  "savanna_PLAND",              "Savanna percentage land descriptor",
  "notforest_PLAND",            "Non-forest natural formation percent land descriptor",
  "tot_IT",                     "Total percentage of area of indigenous territories",
  "NOTackn_IT",                 "Indigenous territories that are not officially acknowledged by government",
  "acknlgd_IT",                 "Government acknowledged indigenous territories",
  "for_noIT",                   "Forest area outside indigenous territories",
  "IT_presence",                "Indicates presence (`yes_IT`) or absence (`no_IT`) of indigenous territories based on `tot_IT` value",
  "IT_acknlgd",                 "Indicates recognition category of indigenous territories: `none`,  `acknowledged_only`, `not_acknowledged`, `both` based on `acknlgd_IT` and `NOTackn_IT` values",
  "FS_noIT",                    "Savanna and forest area outside indigenous territories",
  "habitat_noIT",               "Natural habitat including (forest, savanna and non-forest natural formation) outside indigenous territories",
  "pm25_SUM",                   "Annual sum of fire pollutant particular matter (PM2.5) per municipality",
  "fire_MIN",                   "Minimum fire incidence",
  "fire_MAX",                   "Maximum fire incidence",
  "fire_MEAN",                  "Mean fire incidence",
  "fire_COUNT",                 "Count of fire incidences",
  "fire_SUM",                   "Sum of fire incidences")

write.csv(metadata, here("data", "processed", "metadata.csv"), row.names = FALSE)
print(metadata)
```