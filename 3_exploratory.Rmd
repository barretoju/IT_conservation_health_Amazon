---
title: "Exploratory data analysis of Health, landscape and fire data for Amazon project"
author: "Julia Barreto"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    thumbnails: false
    lightbox: true
    gallery: false
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = F, message = F, warning = F, error= F)
library(here)
library(skimr)
library(GGally)
# library(docxtractr)
library(tidyverse)
library(cowplot)
theme_set(theme_cowplot())
library(kableExtra)
library(readxl)
library(ggplot2)
library(patchwork)
# library(sf)
# library(mapview)
# library(janitor)
```

# Script purpose

This R Markdown document serves as a comprehensive starting point for conducting EDA on your dataset. Each section includes comments explaining its purpose and the specific analyses being performed. You can customize the document further as per your specific dataset and analytical needs. 

Summary content:
- **Introduction**: Briefly describes the purpose of the analysis.
- **Data Loading and Preprocessing**: Loads the dataset and prepares it for analysis.
- **Individual Variable Analysis**: Explores each variable separately, using histograms, boxplots, and density plots to assess distributions, identify outliers, and understand tendencies.
- **Combined Variable Analysis**: Looks at how variables interact, using correlation matrices, grouped analyses, and regression models to explore relationships and impacts.
- **Conclusion**: Summarizes findings and suggests further steps.


## Introduction
 
This document presents an exploratory data analysis (EDA) of a dataset combining environmental factors and health outcomes. The purpose is to understand the individual characteristics of the variables and their interrelationships, especially as they relate to health outcomes. The analysis is structured around three main groups of predictors: landscape composition (e.g., PLAND, ITs), landscape configuration/fragmentation (e.g., ED, ENN_MN), and fire-related metrics.

## Data Loading and Preprocessing

```{r}
data <- read.csv(here::here("data","combined_data.csv"))

summary(data)
```

Data skimr and structure:
```{r}
skim(data); str(data)
```


# Individual Variable Analysis

# Descriptive Statistics
Start with basic descriptive statistics to understand the central tendency, spread, and shape of the variable's distribution:

    -  **Mean and Median**: Understand central tendency.
  
    -  **Standard Deviation and Variance**: Measure of dispersion.
    
    -  **Minimum and Maximum**: Range of values
    
    -  **Skewness and Kurtosis**: Insights into the shape of the distribution.

```{r}
summary(data$for_PLAND)  # Replace 'variable' with your predictor variable name
```

## Visualization
Visualizations can help to see patterns, detect outliers, and understand distribution:

  - **Histograms**: Show the distribution of the variable.
  - **Boxplots**: Identify outliers and the quartile distribution.
  - **Density Plots**: Smoothed version of the histogram, showing the distribution curve.

```{r, fig.width= 10, fig.height= 4}
# Histogram
ghist <- ggplot(data, aes(x = for_PLAND)) + 
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  labs(title = "Histogram of PLAND", x = "for_PLAND", y = "Frequency")

gbox <- ggplot(data, aes(y = for_PLAND)) + 
  geom_boxplot(fill = "tomato", color = "black") +
  labs(title = "Boxplot of PLAND", x = "", y = "for_PLAND")
  
  
gdens <- ggplot(data, aes(x = for_PLAND)) + 
  geom_density(fill = "green", alpha = 0.5) +
  labs(title = "Density Plot of PLAND", x = "for_PLAND", y = "Density")

ghist + gbox + gdens
```

## Check for Missing Values
Determine how much data is missing, which can affect analysis and may require imputation:

  - **Count of Missing Data**: How prevalent are missing values?

```{r}
sum(is.na(data$for_PLAND))
```


## Correlation Analysis
Investigate how the predictor variable correlates with the outcome variable and other predictors:

  - **Correlation Coefficients**: Measure of linear relationship with the outcome.
  - **Scatter Plots**: Visual assessment of the relationship.


```{r}
# Compute correlation
cor_value <- cor(data$for_PLAND, data$for_PD, use = "complete.obs")

# Display the correlation on a plot
ggplot(data, aes(x = for_PD, y = for_PLAND)) +
  geom_point(alpha = 0.5, color = "blue") +
  geom_text(aes(label = paste("Correlation: ", round(cor_value, 2))), 
            x = Inf, y = Inf, hjust = 1.1, vjust = 1.1, size = 6, color = "red") +
  labs(title = "Scatter Plot with Correlation", x = "Patch Density", y = "PLAND") +
  theme_minimal()

```

```{r}
cor(data$for_PLAND, data$for_PD, use = "complete.obs")  # Replace 'outcome' with your outcome variable name
```
library(GGally)

```{r, warning= FALSE}
landscape_data <- data %>% 
  dplyr::select(for_PLAND, for_PD, for_ED, for_ENN_MN, for_AI)

# Use ggpairs to create a scatterplot matrix
ggpairs(landscape_data, 
        upper = list(continuous = wrap("cor", size = 4)),  # Show correlation coefficients in upper panel
        lower = list(continuous = wrap("points", alpha = 0.5, color = "darkgreen")),  # Scatter plots in lower panel
        diag = list(continuous = wrap("barDiag")))  # Histograms on the diagonal
```


<!-- ## aqui aqui aquiaqui -->
<!-- ```{r, eval= FALSE} -->
<!-- # Scatter plot using ggplot2 -->
<!-- ggplot(data, aes(x = outcome, y = variable)) +  -->
<!--   geom_point(alpha = 0.5, color = "blue") + -->
<!--   labs(title = "Scatter Plot of Outcome vs. Variable", x = "Outcome", y = "Variable") + -->
<!--   theme_minimal() -->
<!-- ``` -->


<!-- ## Cross-tabulation and Grouped Statistics (for categorical variables) -->
<!-- If the variable is categorical, look at how different categories relate to the outcome: -->

<!--     - **Frequency Tables**: Count of cases in each category. -->
<!-- Grouped Mean/Median: Comparison of the outcome across categories. -->

<!-- ```{r} -->
<!-- table(data$for_PLAND) -->
<!-- aggregate(data$outcome ~ data$for_PLAND, data = data, FUN = mean) -->
<!-- ``` -->


<!-- ## Advanced Analysis -->
<!-- Depending on the nature of the data and the research questions, you might consider more advanced analyses: -->

<!--     - **Factor Analysis**: For reducing dimensionality in multiple related predictors. -->
<!--     - **ANOVA or Chi-squared Tests**: To test differences between groups for continuous and categorical variables, respectively. -->

<!-- ```{r} -->
<!-- anova_result <- aov(data$outcome ~ data$for_PLAND, data = data) -->
<!-- summary(anova_result) -->
<!-- ``` -->

<!-- ## Time Series Analysis -->
<!-- For time-dependent data, analyze patterns over time: -->

<!--     - **Trend Analysis**: Understanding long-term movement. -->
<!--     - **Seasonality**: Regular pattern of variability within certain time frames. -->

<!-- ```{r} -->
<!-- plot(ts(data$for_PLAND), main = "Time Series Plot of Variable") -->
<!-- ``` -->

<!-- ## Interaction Effects -->
<!-- Examine how the predictor interacts with other variables to affect the outcome: -->

<!--     - **Interaction Term in Regression Model**: Check if the combination of two predictors has a different effect than each predictor alone. -->

<!-- ```{r} -->
<!-- lm_result <- lm(outcome ~ variable * other_variable, data = data) -->
<!-- summary(lm_result) -->
<!-- ``` -->


<!-- ________________________ -->


<!-- ## Landscape Composition -->

<!-- PLAND Percentage of forest: -->
<!-- ```{r} -->
<!-- # View a summary of the PLAND variable -->
<!-- summary(data$for_PLAND) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # Summarize the amount of missing data for the PLAND variable -->
<!-- sum(is.na(data$for_PLAND)) -->

<!-- # Investigate Data Content, why so many NAs -->
<!-- ``` -->


<!-- Percentage of forest: -->

<!-- ```{r} -->
<!-- hist(data$for_PLAND, main="Histogram of PLAND", xlab="Percentage Land Descriptor", breaks=30) -->
<!-- ``` -->

<!-- ```{r, fig.height= 6, fig.width= 8} -->
<!-- # Boxplot for PLAND, exclude NA values explicitly -->
<!-- boxplot(data$for_PLAND[!is.na(data$for_PLAND)], main="Boxplot of PLAND") -->
<!-- ``` -->


<!-- ## Landscape Configuration/Fragmentation -->

<!-- Edge Density (ED) -->
<!-- ```{r} -->
<!-- plot(density(data$ED, na.rm = TRUE), main="Density Plot of Edge Density") -->
<!-- ``` -->

<!-- Nearest Neighbor Distance (ENN_MN): -->
<!-- ```{r} -->
<!-- hist(data$ENN_MN, main="Histogram of Euclidean Nearest Neighbor Distance", xlab="Distance", breaks=30) -->
<!-- ``` -->



<!-- # Fire-related Metrics -->

<!-- ## Fire frequency -->

<!-- Summary and Plot of Fire Data -->

<!-- ```{r} -->
<!-- summary(data$fire_SUM) -->
<!-- hist(data$fire_SUM, main="Histogram of Fire-related Incidences", xlab="Count", breaks=30) -->
<!-- ``` -->


<!-- ## Fire pollutants -->


<!-- # Combined Variable Analysis -->




<!-- ## Correlation Matrix: -->


<!-- ```{r} -->
<!-- cor_data <- data %>% select(PLAND, tot_IT, ED, ENN_MN, fire_related) %>% -->
<!--   na.omit() %>% -->
<!--   cor() -->
<!-- corrplot(cor_data, method="circle") -->
<!-- ``` -->



<!-- # Grouped Analysis by Health Outcome -->


<!-- ```{r} -->
<!-- # Example of a grouped analysis: mean values of predictors by levels of a health outcome -->
<!-- aggregate(cbind(PLAND, ED) ~ health_outcome, data=data, FUN=mean) -->
<!-- Regression Analysis -->
<!-- ``` -->


<!-- ```{r} -->
<!-- lm_result <- lm(health_outcome ~ PLAND + tot_IT + ED + ENN_MN + fire_related, data=data) -->
<!-- summary(lm_result) -->
<!-- ``` -->

<!-- ## Conclusion -->

<!-- This section will summarize the key findings from the exploratory data analysis and suggest potential areas for further research or detailed analysis based on the initial findings. -->



<!--   ____________________________ -->

<!-- ## Disease groupings -->
<!-- Separating into diseases groups (below). (Queries; Q1) Disease groupings are up to discussion, currently using zoonotic and fire-related diseases. The later fire-related diseases are separated into respiratory and cardiovascular. But could also work as acute and chronic. Cerebral infarction and conjunctival disorders occupy circulatory, and pulmonary chronic occupy respiratory. -->

<!-- ```{r} -->
<!-- # Define vectors for disease categories to centralize control and enhance maintainability -->
<!-- zoonotic_diseases <- c("malaria", "visceral_leishmaniasis", "cutaneous_leishmaniasis", -->
<!--                        "chagas", "hantavirus", "rickettsia") -->

<!-- respiratory_diseases <- c("bronchial_emphysema", "chronic_resp", "pneumonia", -->
<!--                           "pharyngitis", "tonsillitis", "laryngitis", "tracheitis", -->
<!--                           "acute_resp", "bronchitis", "neoplasm_respiratory", -->
<!--                           "pulmonary_embolism") -->

<!-- cardiovascular_diseases <- c("conduct_cardiac", "cerebral_infarction", -->
<!--                              "myocardial", "conjunctivitis") -->
<!-- ``` -->

<!--     - Zoonotic diseases: "Malaria", "Leishmaniasis Visceral", "Cutaneous Leishmaniasis", "Chagas disease", "Hantavirus", and "Rickettsia disease – spotted fever". -->

<!--     - Fire-related and respiratory diseases (n= 11): "Neoplasm of trachea, bronchi, and lungs", "Pulmonary embolism", "Pharyngitis", "Tonsillitis", "Other acute upper respiratory tract infections", "Pneumonia", "Acute bronchitis and bronchiolitis", "Laryngitis", "Tracheitis", "Bronchial emphysema", "Other chronic obstructive pulmonary diseases". -->

<!--     - Fire-related cand ardiovascular diseases (n= 4): "Conduct disorders and cardiac arrhythmias", "Cerebral infarction", "Acute myocardial infarction", "Conjunctivitis and other conjunctival disorders". -->

<!--     - Fire-related acute diseases (n= 9): Pharyngitis, Tonsillitis, Other acute upper respiratory tract infections, Pneumonia, Acute bronchitis and bronchiolitis, Laryngitis, Tracheitis, Acute myocardial infarction, Conjunctivitis and other conjunctival disorders -->

<!--     - Fire-relatedchronic diseases (n= 6): Neoplasm of trachea, bronchi, and lungs, Pulmonary embolism, Bronchial emphysema, Other chronic obstructive pulmonary diseases, Conduct disorders and cardiac arrhythmias, Cerebral infarction. -->



<!-- ```{r} -->
<!-- # Update dataset with new categories using centralized control lists -->
<!-- diseases <- diseases %>% -->
<!--   mutate( -->
<!--     G2_respcard = case_when( -->
<!--       abbreviation %in% zoonotic_diseases ~ "zoonotic",  # Easy update and checking of disease types -->
<!--       abbreviation %in% respiratory_diseases ~ "respiratory", -->
<!--       abbreviation %in% cardiovascular_diseases ~ "cardiovascular" -->
<!--     ), -->
<!--     G3_fireindzoo = case_when( -->
<!--       abbreviation %in% zoonotic_diseases ~ abbreviation,  # Direct mapping to maintain traceability of zoonotic diseases -->
<!--       TRUE ~ "fire_related"  # Default category for non-zoonotic diseases -->
<!--     ), -->
<!--     G1_firezoo = if_else(G2_respcard != "zoonotic", "fire_related", "zoonotic"),  # Binary categorization to facilitate analysis -->
<!--     G4_acutechron = case_when( -->
<!--       abbreviation %in% respiratory_diseases[c(8, 9, 10, 11, 12, 13)] ~ "acute",  # Subsetting to specify acute respiratory diseases -->
<!--       abbreviation %in% respiratory_diseases[c(1, 2, 4, 10)] ~ "chronic",  # Subsetting to specify chronic respiratory diseases -->
<!--       TRUE ~ "zoonotic"  # Fallback to zoonotic if neither acute nor chronic -->
<!--     ) -->
<!--   ) -->

<!-- ``` -->


<!-- AQUIAQUI check if that'll be necessary here -->
<!-- ```{r, eval= FALSE} -->
<!-- # Create a dataset with counts for G2_respcard grouping -->
<!-- count_G2 <- diseases %>% -->
<!--   group_by(G2_respcard) %>% -->
<!--   summarise(count = n_distinct(abbreviation), .groups = 'drop') -->

<!-- # Create a dataset with counts for G3_fireindzoo grouping -->
<!-- count_G3 <- diseases %>% -->
<!--   group_by(G3_fireindzoo) %>% -->
<!--   summarise(count = n_distinct(abbreviation), .groups = 'drop') -->

<!-- # Create a dataset with counts for G1_firezoo grouping -->
<!-- count_G1 <- diseases %>% -->
<!--   group_by(G1_firezoo) %>% -->
<!--   summarise(count = n_distinct(abbreviation), .groups = 'drop') -->

<!-- # Create a dataset with counts for G4_acutechron grouping -->
<!-- count_G4 <- diseases %>% -->
<!--   group_by(G4_acutechron) %>% -->
<!--   summarise(count = n_distinct(abbreviation), .groups = 'drop') -->


<!-- # Join these counts back to the original dataset -->
<!-- diseases <- diseases %>% -->
<!--   left_join(count_G2, by = "G2_respcard") %>% -->
<!--   rename(count_G2 = count) %>% -->
<!--   left_join(count_G3, by = "G3_fireindzoo") %>% -->
<!--   rename(count_G3 = count) %>% -->
<!--   left_join(count_G1, by = "G1_firezoo") %>% -->
<!--   rename(count_G1 = count) %>% -->
<!--   left_join(count_G4, by = "G4_acutechron") %>% -->
<!--   rename(count_G4 = count) -->
<!-- ``` -->


<!-- NOTES: -->

<!-- *Group* 4 focus on acute vs chronic diseases: To separate the diseases into categories of acute and chronic based on your list, we can classify them based on common medical definitions where acute diseases are typically rapid onset and of short duration, and chronic diseases are long-developing syndromes. Here's a categorization based on the descriptions: -->

<!-- Acute Diseases: -->
<!-- - **Acute bronchitis and bronchiolitis** -->
<!-- - **Acute myocardial infarction** -->
<!-- - **Cerebral infarction** -->
<!-- - **Conjunctivitis and other conjunctival disorders** -->
<!-- - **Laryngitis** -->
<!-- - **Other acute upper respiratory tract infections** -->
<!-- - **Pharyngitis** -->
<!-- - **Pneumonia** -->
<!-- - **Tonsillitis** -->
<!-- - **Tracheitis** -->

<!-- Chronic Diseases: -->
<!-- - **Bronchial emphysema** -->
<!-- - **Conduct disorders and cardiac arrhythmias** (including chronic arrhythmias) -->
<!-- - **Neoplasm of trachea, bronchi, and lungs** (neoplasms are typically considered chronic) -->
<!-- - **Other chronic obstructive pulmonary diseases** -->
<!-- - **Pulmonary embolism** (can be considered part of chronic pulmonary conditions, although the event itself is acute) -->

<!-- Diseases with Both Acute and Chronic Phases: -->
<!-- Some diseases can have both acute and chronic phases depending on their development and management, such as **Hantavirus** (acute initially, but can have long-lasting effects) -->

<!-- This separation considers typical medical knowledge and the nature of these diseases. If a specific disease's classification differs from typical scenarios or more context is provided, adjustments may be necessary. -->


<!-- # Importing and organizing datasets: -->

<!-- ## Bolivia -->

<!-- ```{r} -->
<!-- data_bolivia <- read_excel(here("../Health_data/Bolivia/Final/Organized", "Bolivia_data.xlsx")) -->

<!-- knitr::kable((data_bolivia %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(data_bolivia), width = "auto") -->
<!-- ``` -->

<!-- Organized by department, supposedly state. It contains COD that gathers country ("BO") and municipality code number (e.g. 10101). -->

<!-- Tidying to standardize: -->
<!-- - rename columns to lower case, department -->
<!-- - order department, country+municipality code, municipality name -->
<!-- - "scale" column that stands for scale of data content -->

<!-- ```{r} -->
<!-- data_bolivia <- data_bolivia %>% -->
<!--   rename(department = DEPARTAMENT) %>% -->
<!--   mutate(scale= "municipality", -->
<!--          country= "Bolivia") %>% -->
<!--   select(country, department, COD, municipality, scale, -->
<!--          -code_municipality, year, 6:19) -->
<!-- ``` -->

<!-- ### Health data prepapartion and treat -->

<!-- Timespan available from `r paste0(range(data_bolivia$year)[1], " to ", range(data_bolivia$year)[2])`. -->

<!-- ```{r} -->
<!-- range(data_bolivia$year) -->
<!-- # check if necessary to correct any wrong string (unique(data_bolivia$year)) or class not numeric (class(data_bolivia$year)) -->

<!-- ``` -->

<!-- Available diseases: -->
<!-- ```{r} -->
<!-- names(data_bolivia)[7:dim(data_bolivia)[2]] -->
<!-- ``` -->


<!-- Divergences and decisions: -->

<!--     - leishmaniasis: visceral or cutaneous? Decided to keep as it can fit broader groupings as zoonotic. -->

<!--     - cardiovascular: broader disease naming than those present on our our original dataset. As there is no good fit to any of the specific cardiocvascular diseases demanded ("Acute myocardial infarction" and "Conduct disorders and cardiac arrhythmias"), we'll keep as broade G2_cardresp grouping. Decided to keep as so. -->

<!--     - respiratory_symptomatic: likewise, can't break down in specific respiratory diseases from original dataset ( "Acute bronchitis and bronchiolitis", "Bronchial emphysema", "Laryngitis", "Neoplasm of trachea, bronchi, and lungs", "Other acute upper respiratory tract infections", "Other chronic obstructive pulmonary diseases", "Pharyngitis", "Pneumonia", "Pulmonary embolism", "Tonsillitis", "Tracheitis"). Decided to edit to respitatory, match G2_cardresp. -->
<!-- ```{r} -->
<!-- data_bolivia <- data_bolivia %>% -->
<!--   dplyr::rename("respiratory"= respiratory_symptomatic) -->
<!-- ``` -->

<!--     - ARI_no_pneumonia: Besides logic column `r unique(data_bolivia$ARI_no_pneumonia)`, column unclear purpose without further details as neither the researcher could provide clarification nor metadata. Unsolvale, therefore removed. -->
<!-- ```{r, echo= FALSE} -->
<!-- data_bolivia <- data_bolivia %>% -->
<!--   dplyr::select(-ARI_no_pneumonia) -->
<!-- ``` -->
<!--     - avian_influenza0809: not useful for project purposes, besides logic column `r unique(data_bolivia$avian_influenza0809)`. Unsolvale, therefore removed. -->
<!-- ```{r, echo= FALSE} -->
<!-- data_bolivia <- data_bolivia %>% -->
<!--   dplyr::select(-avian_influenza0809) -->
<!-- ``` -->

<!--     - smear_negative_tbc: column with unclear purpose, and without further details as neither the researcher could provide clarification nor metadata. Unsolvale, therefore removed. -->
<!-- ```{r, echo= FALSE} -->
<!-- data_bolivia <- data_bolivia %>% -->
<!--   dplyr::select(-smear_negative_tbc) -->
<!-- ``` -->

<!--     - Suspicion columns (`r names(data_bolivia)[grep("_suspicion", names(data_bolivia))]`): not useful for project purposes. Unsolvale, therefore removed. -->
<!-- ```{r, echo=FALSE} -->
<!-- # trying to sum up fire related and zoonotic -->
<!-- data_bolivia <- data_bolivia %>% -->
<!--   dplyr::select(-grep("_suspicion", names(data_bolivia))) -->
<!-- ``` -->



<!-- ### Standardise among datasets -->
<!-- o create a script that matches and renames disease-related columns in your data_bolivia dataset based on a list of abbreviations and then groups these diseases similar to the groupings you previously described, we'll take the following steps: -->

<!-- Step 1: Define Abbreviations and Groupings -->
<!-- First, we'll assume you have a data frame named diseases that contains a column abbreviation with disease abbreviations. We'll also define your groupings based on the descriptions provided earlier. -->

<!-- Step 2: Matching and Renaming Columns -->
<!-- We'll use string matching to rename the disease-related columns in data_bolivia to align with the abbreviations from diseases$abbreviation. After renaming, we'll apply the groupings. -->

<!-- Here's the complete script to achieve this: -->

<!-- ```{r} -->


<!-- # Find and rename matching columns in 'data_bolivia' -->
<!-- column_names <- names(data_bolivia)[7:dim(data_bolivia)[2]]  # Only disease-related columns -->
<!-- target_names <- diseases$abbreviation -->

<!-- # Function to find the best match and return NA if the match is poor -->
<!-- match_and_rename <- function(name) { -->
<!--   distances <- stringdist::stringdist(tolower(name), target_names) -->
<!--   if(min(distances) <= 5) {  # Threshold can be adjusted -->
<!--     return(target_names[which.min(distances)]) -->
<!--   } else { -->
<!--     return(NA) -->
<!--   } -->
<!-- } -->

<!-- # Apply the function to find best matches for renaming -->
<!-- matches <- sapply(column_names, match_and_rename) -->
<!-- names(data_bolivia)[7:dim(data_bolivia)[2]] <- ifelse(is.na(matches), column_names, matches) -->

<!-- # Verify the renamed columns -->
<!-- print(names(data_bolivia)) -->

<!-- # # Append grouping columns based on the matched abbreviations -->
<!-- # data_bolivia2 <- data_bolivia %>% -->
<!-- #   pivot_longer(cardiovascular:respiratory, names_to = "abbreviation", values_to = "n_cases") %>% -->
<!-- #   left_join(diseases %>% -->
<!-- #               dplyr::select(-Diseases_name, -ICD), by = "abbreviation") %>% -->
<!-- #     pivot_wider(names_from = c(abbreviation, G2_respcard, G3_fireindzoo, G1_firezoo, G4_acutechron), values_from = c(n_cases, n_cases, n_cases, n_cases, n_cases)) -->


<!-- # Verify the structure with new groupings -->
<!-- print(head(data_bolivia)) -->
<!-- ``` -->


<!-- Final diseases renamed to standardize among datasets: -->

<!-- I'll do so by identifying the closest matches to the abbreviations I created earlier and rename them. Useful but not final. -->

<!-- ```{r} -->
<!-- # Modified function with debugging output -->
<!-- find_closest_matches_with_warnings <- function(column_names, target_names, threshold = 3) { # Lowered threshold for testing -->
<!--   matches <- sapply(column_names, function(column) { -->
<!--     distances <- stringdist::stringdist(column, target_names) -->
<!--     min_distance <- min(distances) -->
<!--     closest_match <- target_names[which.min(distances)] -->

<!--     # Debugging output -->
<!--     print(paste("Column:", column, "Closest Match:", closest_match, "Distance:", min_distance)) -->

<!--     if (min_distance > threshold) { -->
<!--       warning(paste("Match may not be reliable for column:", column, -->
<!--                     "-> Closest match:", closest_match, -->
<!--                     "with a distance of:", min_distance)) -->
<!--     } -->

<!--     return(closest_match) -->
<!--   }) -->

<!--   return(matches) -->
<!-- } -->

<!-- column_names <- names(data_bolivia)[7:dim(data_bolivia)[2]] -->
<!-- target_names <- diseases$abbreviation  # Make sure this is properly populated -->

<!-- # Find the closest matches, setting a reasonable threshold for warnings -->
<!-- closest_matches <- find_closest_matches_with_warnings(column_names, target_names, threshold = 2) -->

<!-- # Create a named vector for renaming purposes -->
<!-- names(closest_matches) <- column_names -->

<!-- closest_matches <- find_closest_matches_with_warnings(column_names, target_names, -->
<!--                                                       threshold = 3) -->

<!-- # Print to verify contents -->
<!-- print(column_names) -->
<!-- print(target_names) -->

<!-- # Print the results along with any warnings generated -->
<!-- print(data.frame(Column = column_names, Closest_Match = closest_matches)) -->

<!-- ``` -->



<!-- ### Save tidy dataset for Bolivia -->

<!-- Summary BO data treatment/cleaning: -->
<!--   - Remove suspicion cases (chat with PP) -->
<!--   - Remove the T/F "ARI no pneumonia" logical column -->
<!--   - Remove the T/F "avian influenza" logical column -->
<!--   - Remove the "smear_negative_tbc" for its unknown information -->
<!--   - Kept semi-clear columns that for individual diseases are unclear, but works for groupings -->

<!-- ```{r} -->
<!-- BO_full_clean <- data_bolivia -->

<!-- write.csv(BO_full_clean, file=here::here("data","bolivia_cleaned.csv"), -->
<!--           row.names=FALSE) -->
<!-- ``` -->

<!-- Bolivian dataset containing COD, year, diseases groups number of cases and number of diseases: -->
<!-- ```{r} -->


<!-- BO_tidy <- data_bolivia %>% -->
<!--   group_by(COD, year) %>% -->
<!--   summarise(chagas= chagas, -->
<!--             leishmaniasis= leishmaniasis, -->
<!--             malaria= malaria, -->
<!--             zoonotic = sum(chagas, leishmaniasis, malaria, na.rm= TRUE), -->
<!--             n_zoo= 3, -->
<!--             fire_related= sum(pneumonia, respiratory_symptomatic, smear_negative_tbc, cardiovascular, na.rm= TRUE), -->
<!--             n_firel= 4, -->
<!--             respiratory = sum(pneumonia, respiratory_symptomatic, smear_negative_tbc, na.rm= TRUE), -->
<!--             n_resp= 3, -->
<!--             cardiovascular = cardiovascular, -->
<!--             n_cardvasc= 1) -->

<!-- ``` -->



<!-- Data of number of cases/ diseases/ year: -->
<!-- To master with other datasets later -->
<!-- ```{r} -->
<!-- # BOlivia data per year -->
<!-- BO_year <- data_bolivia %>% -->
<!--   pivot_longer(7:dim(data_bolivia)[2], -->
<!--                names_to = "diseases", -->
<!--                values_to = "n_cases") %>% -->
<!--   group_by(year, diseases) %>% -->
<!--   summarise(n_cases= sum(n_cases, na.rm = TRUE)) -->


<!-- Bolivia <- BO_year %>% ungroup() %>% -->
<!--   group_by(diseases) %>% -->
<!--     summarise_at(vars(year), -->
<!--                  list(max = max, min= min)) %>% -->
<!--    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!--    # Disease broad grouping F-R vs zoonotic diseases -->
<!--    mutate(disease_group= as.factor(case_when( -->
<!--     diseases == "cardiovascular" ~ "cardiovascular", -->
<!--     diseases %in% c("pneumonia", "respiratory_symptomatic", "smear_negative_tbc") ~ "respiratory", -->
<!--     diseases %in% c("chagas disease", "leishmaniasis", "malaria", "hantavirus_suspicion", "hemorrhagic_fever_suspicion") ~ "zoonotic"))) -->

<!-- BO_year <- BO_year %>% ungroup() %>% -->
<!--     left_join(Bolivia, by= "diseases") %>% -->
<!--     dplyr::select(diseases, year, n_cases, -->
<!--                   disease_group) %>% -->
<!--     arrange(diseases) %>% -->
<!--     drop_na() -->

<!-- master_year <- BO_year %>% -->
<!--   mutate(country= "Bolivia") %>% -->
<!--   dplyr::select(country, everything()) -->


<!-- Bolivia %>% arrange(diseases) %>% -->
<!--   dplyr::select(-min, -max) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # BO_year %>% ungroup() %>% -->
<!-- #   drop_na() %>% -->
<!-- #   dplyr::select(disease_group, year) %>% -->
<!-- #   group_by(disease_group) %>% -->
<!-- #     summarise_at(vars(year), -->
<!-- #                  list(max = max, min= min)) %>% -->
<!-- #    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!-- #   dplyr::select(-min, -max) -->

<!-- control <- data.frame( -->
<!--   country= c("Bolivia", "", ""), scale= c("municipality", "", ""), aggregate(diseases~ disease_group,data= Bolivia, FUN = function(x) paste0(x,collapse = '; ')), -->
<!--   timespan= c("2001- 2019","2001- 2019","2001- 2019"), -->
<!--   Source= c("Ministerio de Salud y Deportes. (2021, 04 30). Reportes Estadísticos Vigilancia Epidemiológica. Retrieved 08 15, 2023, from Sistema Nacional de Información en Salud: https://estadisticas.minsalud.gob.bo/Default_Vigilancia.aspx", "", ""), -->
<!--   Researcher= c("Nerida Nadia H. Valero", "", ""), -->
<!--   Contact= c("neridanadia@gmail.com", " ", "")) -->
<!-- ``` -->

<!-- ## Brasil -->

<!-- Separated by disease, one dataset each. I'll compile into one. -->

<!-- #### Load diseases datasets: -->

<!-- Brazil's got a tricky code organization, that have both 7 and 6 digits for municipalities. Which is why we'll star from spatial data. -->

<!-- ```{r} -->
<!-- BR_shp <- st_read("../spatial/brasil/BR_Municipios_2020.shp") -->
<!-- BR_shp <- st_transform(BR_shp, crs = 4326) -->
<!-- st_crs(BR_shp) -->

<!-- # select amazonian states only to make lighter -->
<!-- BR_shp <- BR_shp %>% -->
<!--   filter(SIGLA_UF %in% -->
<!--     c("AC","AM","MA","AP","MT","PA","RO","RR","TO")) -->

<!-- BR_codes <- BR_shp %>% as.data.frame() %>% -->
<!--   mutate(country= "Brasil", -->
<!--          COD6BR = paste0("BR", str_sub(CD_MUN, start = 1, end = -2)), -->
<!--          municipality= NM_MUN, -->
<!--          department= SIGLA_UF) %>% -->
<!--   dplyr::select(country, department, -->
<!--                 municipality, COD, COD6BR) -->
<!-- ``` -->

<!-- ##### Respiratory (Fire-related) -->

<!-- ```{r} -->
<!-- resp_br <- read_xlsx(here("../Health_data/Brasil/grupos_IDs/", "Respiratorias_2008_2023.xlsx"), skip = 6) %>% -->
<!--   slice(1:772) %>% -->
<!--   dplyr::select(-"2024", -Total) %>% -->
<!--   mutate(across(2:17, ~ifelse(. == "-", NA, .))) %>% -->
<!--   mutate_at(2:17, as.numeric) %>% -->
<!--   rename(municipality= Município) %>% -->
<!--   mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>% -->
<!--   separate(municipality, into= c("COD", "municipality"), -->
<!--            extra= "merge") %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          scale= "municipality") %>% -->
<!--   pivot_longer(3:18, names_to = "year", -->
<!--                values_to = "resp") %>% -->
<!--   select(COD, scale, year, resp) -->

<!-- data_brasil <- BR_codes %>% -->
<!--   left_join(resp_br, by = c("COD6BR" = "COD")) -->

<!-- head(resp_br) -->
<!-- ``` -->

<!-- ##### Cardiovascular (Fire-related) -->

<!-- ```{r} -->
<!-- card_br <- read_xlsx(here("../Health_data/Brasil/grupos_IDs/", "Circulatorio_2008_2023.xlsx"), skip = 6) %>% -->
<!--   slice(1:772) %>% -->
<!--   dplyr::select(-"2024", -Total) %>% -->
<!--   mutate(across(3:19, ~ifelse(. == "-", NA, .))) %>% -->
<!--   mutate_at(3:19, as.numeric) %>% -->
<!--   rename(municipality= Município) %>% -->
<!--   mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          scale= "municipality") %>% -->
<!--   pivot_longer(3:19, names_to = "year", -->
<!--                values_to = "cardiovasc") %>% -->
<!--   select(COD, scale, year, cardiovasc) -->

<!-- data_brasil <- data_brasil %>% -->
<!--   left_join(card_br %>% -->
<!--               dplyr::select(COD, year, cardiovasc), -->
<!--             by = c("COD6BR" = "COD", "year")) -->
<!-- ``` -->

<!-- ##### Chronics (Fire-related) -->

<!-- ```{r} -->
<!-- cron_br <- read_xlsx(here("../Health_data/Brasil/grupos_IDs/", "Cronicas_2008_2023.xlsx"), skip = 6) %>% -->
<!--   slice(1:772) %>% -->
<!--   dplyr::select(-"2024", -Total) %>% -->
<!--   mutate(across(3:19, ~ifelse(. == "-", NA, .))) %>% -->
<!--   mutate_at(3:19, as.numeric) %>% -->
<!--   rename(municipality= Município) %>% -->
<!--   mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          scale= "municipality") %>% -->
<!--   pivot_longer(3:19, names_to = "year", -->
<!--                values_to = "chronic") %>% -->
<!--   select(COD, scale, year, chronic) -->

<!-- data_brasil <- data_brasil %>% -->
<!--   left_join(cron_br %>% -->
<!--               dplyr::select(COD, year, chronic), -->
<!--             by = c("COD6BR" = "COD", "year")) -->
<!-- ``` -->


<!-- ##### Acute (Fire-related) -->

<!-- ```{r} -->
<!-- acute_br <- read_xlsx(here("../Health_data/Brasil/grupos_IDs/", "Agudas_2008_2023.xlsx"), skip = 6) %>% -->
<!--   slice(1:772) %>% -->
<!--   dplyr::select(-"2024", -Total) %>% -->
<!--   mutate(across(2:17, ~ifelse(. == "-", NA, .))) %>% -->
<!--   mutate_at(2:17, as.numeric) %>% -->
<!--   rename(municipality= Município) %>% -->
<!--   mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>% -->
<!--   separate(municipality, into= c("COD", "municipality"), -->
<!--            extra= "merge") %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          scale= "municipality") %>% -->
<!--   pivot_longer(3:18, names_to = "year", -->
<!--                values_to = "acute") %>% -->
<!--   select(COD, scale, year, acute) -->

<!-- data_brasil <- data_brasil %>% -->
<!--   left_join(acute_br %>% -->
<!--               dplyr::select(COD, year, acute), -->
<!--             by = c("COD6BR" = "COD", "year")) -->
<!-- ``` -->


<!-- #### Zoonotic -->

<!-- First sample chagas to understand the template -->
<!-- ```{r} -->
<!-- chagas_br <- read.csv(here("../Health_data/Brasil", "Chagas_sinannet_cnv_chagasbr160806158_106_192_186.csv"), sep= ";", skip = 4, check.names = F) %>% -->
<!--   mutate_at(2:17, as.numeric) %>% -->
<!--   rename(municipality= 1) %>% -->
<!--   mutate(across(where(is.numeric), ~replace_na(.x, 0))) -->

<!-- head(chagas_br) -->
<!-- ``` -->

<!-- Tidying to standardize: -->
<!-- - remove weird tail lines -->
<!-- - pivot number of cases per years longer -->
<!-- - COD columns containing BR upfront -->
<!-- - add country column -->
<!-- - NA column for state/department -->
<!-- - order department, country+municipality code, municipality name -->
<!-- - "scale" column that stands for scale of data content -->

<!-- ```{r} -->
<!-- chagas_br <- chagas_br  %>% -->
<!--   slice(1:140) %>%  # remove weird lines -->
<!--   dplyr::select(-Total) %>% -->
<!--   separate(1,c("COD", "municipality"), -->
<!--            extra= "merge") %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          department= NA, -->
<!--          scale= "municipality", -->
<!--          country= "Brasil") %>% -->
<!--   pivot_longer(3:18, names_to = "year", -->
<!--                values_to = "chagas") %>% -->
<!--   select(country, department, COD, municipality, scale, year, chagas) -->

<!-- data_brasil <- data_brasil %>% -->
<!--   left_join(chagas_br %>% -->
<!--               dplyr::select(COD, year, chagas), -->
<!--             by = c("COD6BR" = "COD", "year")) -->
<!-- ``` -->

<!-- Now the other diseases: -->
<!-- ```{r} -->
<!-- hanta_br <- read.csv(here("../Health_data/Brasil", "Hantavirose_sinannet_cnv_hantabr161020158_106_192_186.csv"), sep= ";", skip = 4, check.names = F) %>% -->
<!--   mutate_at(2:19, as.numeric) %>% -->
<!--   rename(municipality= 1) %>% -->
<!--     mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>% -->
<!--   slice(1:45) %>%  # remove weird lines -->
<!--   dplyr::select(-Total) %>% -->
<!--   separate(1,c("COD", "municipality"), extra = "merge") %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          department= NA, -->
<!--          scale= "municipality", -->
<!--          country= "Brasil") %>% -->
<!--   pivot_longer(3:18, names_to = "year", -->
<!--                values_to = "hantavirus") %>% -->
<!--   select(country, department, COD, municipality, scale, year, hantavirus) -->

<!-- data_brasil <- data_brasil %>% -->
<!--   left_join(hanta_br %>% -->
<!--               dplyr::select(COD, year, hantavirus), -->
<!--             by = c("COD6BR" = "COD", "year")) -->

<!-- leishT_br <- read.csv(here("../Health_data/Brasil", "Leish_Tegumentar_sinannet_cnv_leishvbr161200158_106_192_186.csv"), sep= ";", skip = 5, check.names = F) %>% -->
<!--   mutate_at(2:17, as.numeric) %>% -->
<!--   rename(municipality= 1) %>% -->
<!--     mutate(across(where(is.numeric), ~replace_na(.x, 0))) -->

<!-- # there are offending strings to the vector, fixing: -->
<!-- leishT_br$municipality <- stringr::str_conv(leishT_br$municipality, "UTF-8") -->

<!-- leishT_br <- leishT_br  %>% -->
<!--   slice(1:766) %>%  # remove weird lines -->
<!--   dplyr::select(-Total) %>% -->
<!--   separate(1, c("COD", "municipality"), extra = "merge") %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          department= NA, -->
<!--          scale= "municipality", -->
<!--          country= "Brasil") %>% -->
<!--   pivot_longer(3:18, names_to = "year", -->
<!--                values_to = "leish_teg") %>% -->
<!--   select(country, department, COD, municipality, scale, year, leish_teg) -->

<!-- data_brasil <- data_brasil %>% -->
<!--   left_join(leishT_br %>% dplyr::select(COD, year, leish_teg), -->
<!--             by = c("COD6BR" = "COD", "year")) -->

<!-- leishV_br <- read.csv(here("../Health_data/Brasil", "Leish_Visceral_sinannet_cnv_leishvbr161200158_106_192_186.csv"), sep= ";", skip = 5, check.names = F) %>% -->
<!--   mutate_at(2:33, as.numeric) %>% -->
<!--   rename(municipality= 1) %>% -->
<!--     mutate(across(where(is.numeric), ~replace_na(.x, 0)))  %>% -->
<!--   slice(1:373) %>%  # remove weird lines -->
<!--   dplyr::select(-Total) %>% -->
<!--   separate(1, c("COD", "municipality"), extra = "merge") %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          department= NA, -->
<!--          scale= "municipality", -->
<!--          country= "Brasil") %>% -->
<!--   pivot_longer(3:34, names_to = "year", -->
<!--                values_to = "leish_visc") %>% -->
<!--   select(country, department, COD, municipality, scale, year, leish_visc) -->

<!-- data_brasil <- data_brasil %>% -->
<!--   left_join(leishV_br %>% dplyr::select(COD, year, leish_visc), -->
<!--             by = c("COD6BR" = "COD", "year")) -->

<!-- malaria_br <- read.csv(here("../Health_data/Brasil", "Malaria_sinannet_cnv_malabr161444158_106_192_186.csv"), sep= ";", skip = 5, check.names = F) %>% -->
<!--   mutate_at(2:19, as.numeric) %>% -->
<!--   rename(municipality= 1) %>% -->
<!--     mutate(across(where(is.numeric), ~replace_na(.x, 0))) %>% -->
<!--   slice(1:148) %>%  # remove weird lines -->
<!--   dplyr::select(-Total) %>% -->
<!--   separate(1, c("COD", "municipality"), extra = "merge") %>% -->
<!--   mutate(COD= paste0("BR", COD), -->
<!--          department= NA, -->
<!--          scale= "municipality", -->
<!--          country= "Brasil") %>% -->
<!--   pivot_longer(3:20, names_to = "year", -->
<!--                values_to = "malaria") %>% -->
<!--   select(country, department, COD, municipality, scale, year, malaria) -->

<!-- data_brasil <- data_brasil %>% -->
<!--   left_join(malaria_br %>% dplyr::select(COD, year, malaria), -->
<!--             by = c("COD6BR" = "COD", "year")) %>% -->
<!--   mutate(across(where(is.numeric), ~replace_na(.x, 0))) -->
<!-- ``` -->


<!-- ```{r echo= FALSE} -->
<!-- knitr::kable((data_brasil %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(data_brasil), width = "auto") -->
<!-- ``` -->

<!-- Save tidy dataset, the closer to raw: -->
<!-- ```{r} -->
<!-- BR_full_clean <- data_brasil -->

<!-- write.csv(BR_full_clean, file=here::here("data","brasil_cleaned.csv"), -->
<!--           row.names=FALSE) -->
<!-- # remove 6 number code to standardise one COD column -->
<!-- data_brasil <- data_brasil %>% -->
<!--   dplyr::select(-COD6BR) %>% -->
<!--   drop_na(year) -->

<!-- ``` -->

<!-- ### Health data prepapartion and treat -->

<!-- Timespan available from `r paste0(range(data_brasil$year)[1], " to ", range(data_brasil$year)[2])`. -->

<!-- ```{r} -->
<!-- range(data_brasil$year) -->
<!-- # check if necessary to correct any wrong string (unique(data_brasil$year)) or class not numeric (class(data_brasil$year)) -->
<!-- ``` -->

<!-- Available diseases: -->
<!-- ```{r} -->
<!-- names(data_brasil)[7:dim(data_brasil)[2]] -->
<!-- ``` -->

<!-- Data of number of cases/ diseases/ year: -->
<!-- To master with other datasets later -->
<!-- ```{r} -->
<!-- # Brasil data per year -->
<!-- BR_year <- data_brasil %>% -->
<!--   pivot_longer(7:dim(data_brasil)[2], -->
<!--                names_to = "diseases", -->
<!--                values_to = "n_cases") %>% -->
<!--   group_by(year, diseases) %>% -->
<!--   summarise(n_cases= sum(n_cases, na.rm = TRUE)) -->

<!-- Brasil <- BR_year %>% ungroup() %>% -->
<!--   group_by(diseases) %>% -->
<!--     summarise_at(vars(year), -->
<!--                  list(max = max, min= min)) %>% -->
<!--    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!--    # Disease broad grouping F-R vs zoonotic diseases -->
<!--    mutate(disease_group= case_when( -->
<!--      diseases== "fire_related"~ "fire-related", -->
<!--      diseases %in% c("chagas", "fire_related", "hantavirus", "leish_teg", "leish_visc", "malaria") ~ "zoonotic"), -->
<!--      D2= ifelse(diseases == "leish_teg" | diseases == "leish_visc", "leishmaniasis", diseases)) -->

<!-- BR_year <- BR_year %>% ungroup() %>% -->
<!--     left_join(Brasil, by= "diseases") %>% -->
<!--     dplyr::select(diseases, year, n_cases, -->
<!--                   disease_group) %>% -->
<!--     arrange(diseases) %>% -->
<!--     drop_na() -->

<!-- master_year <- rbind(master_year, -->
<!--           BR_year %>% -->
<!--   mutate(country= "Brasil") %>% -->
<!--   dplyr::select(country, everything())) -->


<!-- Brasil %>% arrange(diseases) %>% -->
<!--   dplyr::select(-min, -max) -->
<!-- ``` -->


<!-- ### Summary BR data treatment -->
<!--   - Coerce na into zeros -->
<!--   - no state/department columns, only at the scale of analysis level= municipality -->
<!--   - Got COD by matching municipality names -->
<!--   - Fire-related disases data gathered both types, see necessity to tear apart, dep analytical approach -->

<!-- ```{r} -->
<!-- # BR_year %>% ungroup() %>% -->
<!-- #   drop_na() %>% -->
<!-- #   dplyr::select(disease_group, year) %>% -->
<!-- #   group_by(disease_group) %>% -->
<!-- #     summarise_at(vars(year), -->
<!-- #                  list(max = max, min= min)) %>% -->
<!-- #    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!-- #   dplyr::select(-min, -max) -->

<!-- control <- rbind(control, -->
<!--   c(country= "Brasil", scale= "municipality", -->
<!--     aggregate(diseases~ disease_group,data= Brasil, FUN = function(x) paste0(x,collapse = '; '))[1,], -->
<!--   timespan= "2006-2019", -->
<!--   Source= "https://datasus.saude.gov.br/acesso-a-informacao/doencas-e-agravos-de-notificacao-de-2007-em-diante-sinan/ ; https://datasus.saude.gov.br/informacoes-de-saude-tabnet/ ; http://tabnet.datasus.gov.br/cgi/deftohtm.exe?sinannet/cnv/chagasbr.def ; http://tabnet.datasus.gov.br/cgi/deftohtm.exe?sinannet/cnv/hantabr.def ; http://tabnet.datasus.gov.br/cgi/deftohtm.exe?sinannet/cnv/leishvbr.def ; http://tabnet.datasus.gov.br/cgi/deftohtm.exe?sinannet/cnv/ltabr.def ; http://tabnet.datasus.gov.br/cgi/deftohtm.exe?sinannet/cnv/malabr.def", -->
<!--                    Researcher= "Paula Prist", -->
<!--                    Contact= "prist@ecohealthalliance.org"), -->
<!--   c(country= "", scale= "", aggregate(diseases~ disease_group,data= Brasil, FUN = function(x) paste0(x,collapse = '; '))[2,], -->
<!--   timespan= "", -->
<!--   Source= "", -->
<!--                    Researcher= "", -->
<!--                    Contact= "")) -->
<!-- ``` -->


<!-- ## Colombia -->

<!-- ```{r} -->
<!-- data_colombia <- read_excel(here("../Health_data/", "Colombia", "Dados_saude_actualizado.xlsx")) %>% -->
<!--   rename_all(., .funs = tolower) # many names in upper case, tolower them -->

<!-- knitr::kable((data_colombia %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(data_colombia), width = "auto") -->
<!-- ``` -->

<!-- Organized by department (supposedly state), year and municipality (ADM2). -->

<!-- Tidying to standardize: -->
<!-- - get COD data from adm shapes (code 2), absent data and match was unperfect -->
<!-- - apparently NA stand for zero -->
<!-- - rename columns to english -->
<!-- - rename columns department to department -->
<!-- - build municipality code column (should I? Querie) -->
<!-- - order department, country+municipality code, municipality name -->
<!-- - "scale" column that stands for scale of data content -->

<!-- #### Get municipality code -->
<!-- ```{r} -->

<!-- # read countries shapefile -->
<!-- CO_shp <- st_read("../spatial/colombia/col_admbnda_adm2_mgn_20200416.shp") -->
<!-- # get codes df -->
<!-- CO_codes <- data.frame(CO_shp) -->

<!-- # Function to remove accents and convert to lowercase --> -->
<!--  normalize_string <- function(x) { -->
<!--    x <- iconv(x, "UTF-8", "ASCII//TRANSLIT")  # Remove accents -->
<!--    x <- tolower(x)  # Convert to lowercase -->
<!--    return(x) -->
<!--    } -->

<!-- # Normalize strings in both data frames -->
<!-- CO_codes$ADM2_ES_normalized <- normalize_string(CO_codes$ADM2_ES) -->
<!-- data_colombia$municipio_normalized <- normalize_string(data_colombia$municipio) -->

<!-- # Fuzzy string matching -->
<!-- matches <- stringdist::amatch(data_colombia$municipio_normalized, -->
<!--                   CO_codes$ADM2_ES_normalized, maxDist = 6, method = "osa") -->

<!-- # Create a new column in data_colombia with matching values from ADM1_PCODE in df1 -->
<!-- data_colombia$COD <- CO_codes$ADM2_PCODE[matches] -->

<!-- # test where it did not work: -->
<!-- # View(data_colombia[is.na(data_colombia$COD),]) -->

<!-- # extract to verify manually -->
<!-- unique(data_colombia[is.na(data_colombia$COD), c("departamento", "municipio")]) -->

<!-- # entry manually -->
<!-- data_colombia$COD[data_colombia$municipio== "PAPUNAUA (MORICHAL)"] <- CO_codes$ADM2_PCODE[CO_codes$ADM1_ES == "Vaupés" & CO_codes$ADM2_ES== "Papunahua"] -->

<!-- data_colombia$COD[data_colombia$municipio== "SAN MIGUEL (LA DORADA)"] <- -->
<!--   CO_codes$ADM2_PCODE[CO_codes$ADM1_ES == "Putumayo" & CO_codes$ADM2_ES== "San Miguel"] -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # names(data_colombia) -->
<!-- data_colombia <- data_colombia %>% -->
<!--   dplyr::select(-municipio_normalized) %>% -->
<!--   rename(department = departamento, -->
<!--          municipality= municipio, -->
<!--          year= año) %>% -->
<!--   mutate(scale= "municipality", -->
<!--          country= "Colombia") %>% -->
<!--   group_by(department, municipality) %>% -->
<!--   mutate_at(4:23, ~replace_na(.x, 0)) %>% -->
<!--   select(country, department, COD, municipality, scale, year, 4:23) -->
<!-- ``` -->

<!-- ### Health data prepapartion and treat -->

<!-- Timespan available from `r paste0(range(data_colombia$year)[1], " to ", range(data_colombia$year)[2])`. -->

<!-- ```{r} -->
<!-- range(data_colombia$year) -->
<!-- # check if necessary to correct any wrong string (unique(data_colombia$year)) or class not numeric (class(data_colombia$year)) -->
<!-- ``` -->

<!-- Available diseases: -->

<!-- ```{r} -->
<!-- names(data_colombia)[7:26] -->
<!-- ``` -->


<!-- DECISIONS: -->
<!-- - Mutate all four malarias into just 'malaria'. Catalina, the responsible researcher for compiling Colombian health data, confirmed are not redundant. -->

<!-- - Same for Leishmaniasis, separated both cutanea and mucosa, none stand for visceral. PP and I do not see the distinction as useful for current goals,so it can be grouped into just Leishmaniasis. -->

<!-- Save tidy dataset, the closer to raw: -->
<!-- ```{r} -->
<!-- CO_full_clean <- data_colombia -->

<!-- write.csv(CO_full_clean, file=here::here("data","colombia_cleaned.csv"), -->
<!--           row.names=FALSE) -->
<!-- ``` -->

<!-- - Besides group them broadly by fire related diseases ("conjuntivitis and other conjuntival disorders", "acute bronchitis and bronchiolitis", "other chronic obstructive pulmonary diseases", "pneumonia", "pharyngitis", "tonsilitis", "laryngitis", "tracheitis", "conduction disorders and cardiac arrhytmias", "cerebral infarction", "acute myocardial infarction", "pulmonary embolism"); and zoonotic diseases ("malaria asociada", "malaria_complicada", "malaria falciparum", "malaria vivax", "leishmaniasis cutanea", "leishmaniasis mucosa", "chagas", "rickettsial disease") -->

<!-- Data of number of cases/ diseases/ year: -->
<!-- To master with other datasets later -->
<!-- ```{r} -->
<!-- # Colombia data per year -->
<!-- CO_year <- data_colombia %>% -->
<!--   pivot_longer(7:dim(data_colombia)[2], -->
<!--                names_to = "diseases", -->
<!--                values_to = "n_cases") %>% -->
<!--   group_by(year, diseases) %>% -->
<!--   summarise(n_cases= sum(n_cases, na.rm = TRUE)) -->


<!-- Colombia <- CO_year %>% ungroup() %>% -->
<!--   group_by(diseases) %>% -->
<!--     summarise_at(vars(year), -->
<!--                  list(max = max, min= min)) %>% -->
<!--    mutate(timespan= paste0(min, "- ", max), -->
<!--    # Disease broad grouping F-R vs zoonotic diseases -->
<!--     disease_group= as.factor(case_when( -->
<!--       diseases %in% c( -->
<!--     "conjuntivitis and other conjuntival disorders", -->
<!--     "acute bronchitis and bronchiolitis", -->
<!--     "other chronic obstructive pulmonary diseases", -->
<!--     "pneumonia", -->
<!--     "pharyngitis", -->
<!--     "tonsilitis", -->
<!--     "laryngitis", -->
<!--     "tracheitis") ~ "respiratory", -->

<!--     diseases %in% c( -->
<!--       "conduction disorders and cardiac arrhytmias", -->
<!--       "cerebral infarction", -->
<!--       "acute myocardial infarction", -->
<!--       "pulmonary embolism") ~ "cardiovascular", -->

<!--     diseases %in% c("malaria asociada", "malaria_complicada", "malaria falciparum", "malaria vivax", "leishmaniasis cutanea", "leishmaniasis mucosa", "chagas", "rickettsial disease") ~ "zoonotic")), -->
<!--     D2= case_when( -->
<!--       diseases %in% c("malaria asociada", "malaria_complicada", "malaria falciparum", "malaria vivax") ~ "malaria", -->
<!--     diseases %in% c("leishmaniasis cutanea", "leishmaniasis mucosa") ~ "leishmaniasis", -->
<!--     diseases== "rickettsial disease" ~ "rickettsia"), -->
<!--    D2= case_when( -->
<!--      disease_group!= "zoonotic" ~ disease_group, -->
<!--                  is.na(D2) ~ "chagas", TRUE ~ D2)) -->

<!-- CO_year <- CO_year %>% ungroup() %>% -->
<!--     left_join(Colombia, by= "diseases") %>% -->
<!--     dplyr::select(diseases, year, n_cases, -->
<!--                   disease_group) %>% -->
<!--     arrange(diseases) -->

<!-- master_year <- rbind(master_year, -->
<!--           CO_year %>% -->
<!--   mutate(country= "Colombia") %>% -->
<!--   dplyr::select(country, everything())) -->


<!-- Colombia %>% arrange(diseases) %>% -->
<!--   dplyr::select(-min, -max) -->
<!-- ``` -->


<!-- ### Summary CO data treatment -->
<!--   - Coerce NA into zeros -->
<!--   - gathered diseases, malarias and leishmaniasis (TO DO Q) PP) -->

<!-- ```{r} -->
<!-- # CO_year %>% ungroup() %>% -->
<!-- #   drop_na() %>% -->
<!-- #   dplyr::select(disease_group, year) %>% -->
<!-- #   group_by(disease_group) %>% -->
<!-- #     summarise_at(vars(year), -->
<!-- #                  list(max = max, min= min)) %>% -->
<!-- #    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!-- #   dplyr::select(-min, -max) -->

<!-- control <- rbind(control, -->
<!--   c(country= "Colombia", scale= "municipality", aggregate(diseases~ disease_group,data= Colombia, FUN = function(x) paste0(x,collapse = '; '))[1,], -->
<!--   timespan= "2007-2019", -->
<!--   Source= "https://portalsivigila.ins.gov.co/Paginas/Buscador.aspx", -->
<!--   Researcher= "Catalina Zuluaga", -->
<!--   Contact= "americata@gmail.com"), -->
<!--   c(country= "", scale= "", aggregate(diseases~ disease_group,data= Colombia, FUN = function(x) paste0(x,collapse = '; '))[2,], -->
<!--   timespan= "2007-2019", -->
<!--   Source= " ", -->
<!--   Researcher= " ", -->
<!--   Contact= " "), -->
<!--   c(country= "", scale= "", aggregate(diseases~ disease_group,data= Colombia, FUN = function(x) paste0(x,collapse = '; '))[3,], -->
<!--   timespan= "2007-2019", -->
<!--   Source= " ", -->
<!--   Researcher= " ", -->
<!--   Contact= " ")) -->
<!-- ``` -->


<!-- ## Ecuador -->

<!-- At this point I am working on sorting diagnostics, which we found two different templates shown below. For instance, 2016 contains three report columns, so we scan through those to find the disease by string detection. And e.g. 2021, that contains the original codes, so we extract them to diagnostics. Two problems with that: (i) unperfect matching, and the amount of data limits checking beyond automatic and some random human verification; and (ii) more than one diagnostics, that could maybe be solved with some hierarchy between columns (possibly the last one is the most updated/accurate.) Any inputs or insights on that are very welcomed! -->

<!-- First steps in more detail below: -->

<!-- General overview: -->
<!-- No metadata available. Looking manually at each, data comes with hospital beds and exits ('egresos hospitalarios') per year, from 2015 till 2021 (-2018). All come in CSV format, except for 2018 that is on an alternative spss (.sav) format, so far unreadable but we are trying to work it out. -->

<!-- ```{r} -->
<!-- dir(here("../Health_data/Ecuador/dados_egressos/")) -->
<!-- ``` -->

<!-- 1) get parroquia code from 2020 data, as not all years had it: -->
<!-- ```{r} -->
<!-- # extracting parroquia code from matched names -->
<!-- parr_code <- read_excel(here("../Health_data/Ecuador/", "COD_EC_parr.xlsx")) %>% -->
<!--   rename(municipality= parr_ubi, department= prov_ubi) -->
<!-- ``` -->

<!-- Some years contain diseases by standardized diseases code provided (e.g. 2020, 2019), that we name after that reference; but other don't (e.g. 2020, 2021, 2016). -->


<!-- #### E.g Ecuador 2015, 16, 19 and 20 -->


<!-- First extract the 2015 from the original spss .sav format, -->
<!-- ```{r eval=FALSE} -->
<!-- library(haven) -->
<!-- library(readr) -->

<!-- ecua_15 <- read_sav("../Health_data/Ecuador/Egresos_hospitalarios_2015.sav") %>% -->
<!-- write_csv(path= "../Health_data/Ecuador/dados_egressos/Egresos_hospitalarios_2015.csv") -->
<!-- ``` -->


<!-- ```{r} -->
<!-- ecua_15 <- read.csv(here("../Health_data/Ecuador/dados_egressos", "Egresos_hospitalarios_2015.csv"), -->
<!--                     sep= ",", check.names = F) %>% -->
<!--   dplyr::select(-cant_ubi) %>% -->
<!--   rename(COD= parr_ubi) %>% -->
<!--   mutate(country= "Ecuador", -->
<!--          scale= "parroquia", -->
<!--          year= 2015, -->
<!--          COD = ifelse(nchar(COD) == 5, paste0("0", COD), COD), -->
<!--          COD = paste0("EC", COD)) %>% -->
<!--   left_join(parr_code, by= "COD") -->
<!-- ``` -->

<!-- ```{r echo= FALSE} -->
<!-- knitr::kable((ecua_15 %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(ecua_15), width = "auto") -->
<!-- ``` -->


<!-- Try to get the diseases name by mentioned code: -->
<!-- ```{r} -->
<!-- # First expand diseases to detect each code on R code called ëxpand_ICD.R), import product to cross it. -->
<!-- expanded_diseases_df <- read_xlsx("../Health_data/expanded_ICD_OK.xlsx") %>% -->
<!-- # i've noticed some of the unmatched are due to dot within the code, I'll remove to see if helps -->
<!--  mutate(cau_cie10 = sub("\\.", "", ICD), -->
<!--    Diseases_name= case_when( -->
<!--       Diseases_name== "Malaria"~ "malaria", -->
<!--       Diseases_name== "Hantavirus" ~ "hantavirus", -->
<!--       Diseases_name %in% c("Leishmaniasis Visceral", "Cutaneous Leishmaniasis") ~ "leishmaniasis", -->
<!--     Diseases_name== "Rickettsia disease – spotted fever" ~ "rickettsia", -->
<!--     Diseases_name== "Chagas disease" ~"chagas", -->
<!--    TRUE ~ Diseases_name)) -->

<!-- # Left join echo_15 and expanded_diseases_df on ICD code -->
<!-- ecua_15 <- ecua_15 %>% -->
<!--   left_join(expanded_diseases_df, by = "cau_cie10") %>% -->
<!--   left_join(expanded_diseases_df, by = c("causa3" = "cau_cie10")) %>% -->
<!--   mutate(Diseases_name = coalesce(Diseases_name.x, Diseases_name.y), disease_group = coalesce(disease_group.x, disease_group.y), D2 = coalesce(D2.x, D2.y)) %>% -->
<!--   select(-Diseases_name.x, -Diseases_name.y, -disease_group.x, -disease_group.y, -D2.x, -D2.y) -->

<!-- # check correspondences -->
<!-- # ecua_15 %>% filter(is.na(Diseases_name)) %>% -->
<!-- #   select(cau_cie10) -->

<!-- # i've checked a few examples (around 30) and found no more correspodence, I believe I've reached the far we could go identifying diseases by code withing 2015 data -->

<!-- ecua_15 <- ecua_15 %>% -->
<!--   drop_na(Diseases_name) %>% -->
<!--   dplyr::select(country, department, municipality, scale, COD, year, Diseases_name, disease_group, D2) -->
<!-- ``` -->

<!-- 2016: -->

<!-- ```{r} -->
<!-- ecua_16 <- read.csv(here("../Health_data/Ecuador/dados_egressos", "egresos_hospitalarios_2016.csv"), -->
<!--                     sep= ";", check.names = F) %>% -->
<!--   dplyr::select(-cant_ubi) %>% -->
<!--   rename(COD= parr_ubi) %>% -->
<!--   mutate(country= "Ecuador", -->
<!--          scale= "parroquia", -->
<!--          year= 2016, -->
<!--          COD = ifelse(nchar(COD) == 5, paste0("0", COD), COD), -->
<!--          COD = paste0("EC", COD)) %>% -->
<!--   left_join(parr_code, by= "COD") -->
<!-- ``` -->

<!-- Apparently columns "cau_cie10" contains detectable disease string: ecua_16 df cau_cie10; that seems to match diseasesdf ICD, after some work (separate by ';', remove dots, etc). A second column "causa3" is a subset of this, may could double validate any inconsistency. This template goes for most years (also 2019, 2020 and 2021). -->

<!-- ```{r echo= FALSE} -->
<!-- knitr::kable((ecua_16 %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(ecua_16), width = "auto") -->
<!-- ``` -->


<!-- Try to get the diseases name by mentioned code: -->
<!-- ```{r} -->
<!-- # Left join echo_16 and expanded_diseases_df on ICD code -->
<!-- ecua_16 <- ecua_16 %>% -->
<!--   left_join(expanded_diseases_df, by = "cau_cie10") %>% -->
<!--   left_join(expanded_diseases_df, by = c("causa3" = "cau_cie10")) %>% -->
<!--   mutate(Diseases_name = coalesce(Diseases_name.x, Diseases_name.y), disease_group = coalesce(disease_group.x, disease_group.y), D2 = coalesce(D2.x, D2.y)) %>% -->
<!--   select(-Diseases_name.x, -Diseases_name.y, -disease_group.x, -disease_group.y, -D2.x, -D2.y) -->

<!-- # check correspondences -->
<!-- # ecua_16 %>% filter(is.na(Diseases_name)) %>% -->
<!-- #   select(cau_cie10) -->

<!-- # i've checked a few examples (around 30) and found no more correspodence, I believe I've reached the far we could go identifying diseases by code withing 2016 data -->

<!-- ecua_16 <- ecua_16 %>% -->
<!--   drop_na(Diseases_name) %>% -->
<!--   dplyr::select(country, department, municipality, scale, COD, year, Diseases_name, disease_group, D2) -->

<!-- data_ecuador <- ecua_15 %>% -->
<!--   bind_rows(ecua_16) -->
<!-- ``` -->

<!-- 2018: # aquiaquiaqui aqui eval false -->
<!-- ```{r eval= FALSE} -->
<!-- ecua_18 <- read_sav("../Health_data/Ecuador/Egresos_hospitalarios_2018.sav") %>% -->
<!-- write_csv(path= "../Health_data/Ecuador/dados_egressos/Egresos_hospitalarios_2015.csv") -->
<!-- ``` -->


<!-- 2019: -->
<!-- ```{r} -->
<!-- ecua_19 <- read.csv(here("../Health_data/Ecuador/dados_egressos", "egresos_hospitalarios_2019.csv"), -->
<!--                     sep= ";", check.names = F) %>% -->
<!--   dplyr::select(-cant_ubi) %>% -->
<!--   rename(COD= parr_ubi) %>% -->
<!--   mutate(country= "Ecuador", -->
<!--          scale= "parroquia", -->
<!--          year= 2019, -->
<!--          COD = ifelse(nchar(COD) == 5, paste0("0", COD), COD), -->
<!--          COD = paste0("EC", COD)) %>% -->
<!--   left_join(parr_code, by= "COD") -->

<!-- ecua_19 <- ecua_19 %>% -->
<!--   left_join(expanded_diseases_df, by = "cau_cie10") %>% -->
<!--   left_join(expanded_diseases_df, by = c("causa3" = "cau_cie10")) %>% -->
<!--    mutate(Diseases_name = coalesce(Diseases_name.x, Diseases_name.y), disease_group = coalesce(disease_group.x, disease_group.y), D2 = coalesce(D2.x, D2.y)) %>% -->
<!--   select(-Diseases_name.x, -Diseases_name.y, -disease_group.x, -disease_group.y, -D2.x, -D2.y) -->

<!-- # check correspondences -->
<!-- ecua_19 %>% filter(is.na(Diseases_name)) %>% -->
<!--   select(cau_cie10) -->

<!-- # i've checked a few examples (around 30) and found no more correspodence, I believe I've reached the far we could go identifying diseases by code withing 2016 data -->
<!-- ecua_19 <- ecua_19 %>% -->
<!--   drop_na(Diseases_name) %>% -->
<!--   dplyr::select(country, department, municipality, scale, COD, year, Diseases_name, disease_group, D2) -->

<!-- data_ecuador <- data_ecuador %>% -->
<!--   bind_rows(ecua_19) -->
<!-- ``` -->

<!-- 2020: -->
<!-- ```{r} -->
<!-- ecua_20 <- read.csv(here("../Health_data/Ecuador/dados_egressos", "egresos_hospitalarios_2020.csv"), -->
<!--                     sep= ";", check.names = F) %>% -->
<!--   dplyr::select(-cant_ubi) %>% -->
<!--   rename(COD= parr_ubi) %>% -->
<!--   mutate(country= "Ecuador", -->
<!--          scale= "parroquia", -->
<!--          year= 2020, -->
<!--          COD = ifelse(nchar(COD) == 5, paste0("0", COD), COD), -->
<!--          COD = paste0("EC", COD)) %>% -->
<!--   left_join(parr_code, by= "COD") -->


<!-- ecua_20 <- ecua_20 %>% -->
<!--   left_join(expanded_diseases_df, by = "cau_cie10") %>% -->
<!--   left_join(expanded_diseases_df, by = c("causa3" = "cau_cie10")) %>% -->
<!--    mutate(Diseases_name = coalesce(Diseases_name.x, Diseases_name.y), disease_group = coalesce(disease_group.x, disease_group.y), D2 = coalesce(D2.x, D2.y)) %>% -->
<!--   select(-Diseases_name.x, -Diseases_name.y, -disease_group.x, -disease_group.y, -D2.x, -D2.y) -->

<!-- # check correspondences -->
<!-- ecua_20 %>% filter(is.na(Diseases_name)) %>% -->
<!--   select(cau_cie10) -->

<!-- # i've checked a few examples (around 30) and found no more correspodence, I believe I've reached the far we could go identifying diseases by code withing 2016 data -->
<!-- ecua_20 <- ecua_20 %>% -->
<!--   drop_na(Diseases_name) %>% -->
<!--   dplyr::select(country, department, municipality, scale, COD, year, Diseases_name, disease_group, D2) -->


<!-- data_ecuador <- data_ecuador %>% -->
<!--   bind_rows(ecua_20) %>% -->
<!--   group_by(country, department, COD, municipality, scale, year, Diseases_name) %>% -->
<!--   summarise(count = n()) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(country, department, COD, municipality, scale, year) %>% -->
<!-- # Pivot wider to get diseases_names as columns and count as values -->
<!--   pivot_wider(names_from = Diseases_name, -->
<!--               values_from = count, -->
<!--               values_fill = 0) -->
<!-- ``` -->

<!-- ### E.g Ecuador 2017 and 2021 -->

<!-- This is a trickier case, barely mention codes. The columns with same name from later datasets are now a text columns with description of pacient state. Besides those columns, now some additonal ("cap221rx", "cau221rx" and "cau298rx") also follow that. Therefore we seem to have a text diagnostics coming within five subsequent columns, that can maybe infer temporal hierarchy (if so prioritize latest diagnostics?). Either way, first step for this template data would be to detect disease by string, so work full to treat diseases string detection one by one, for each column, for each year. -->
<!-- ```{r eval= FALSE} -->
<!-- ecua_17 <- read.csv(here("../Health_data/Ecuador/dados_egressos", "egresos_hospitalarios_2017.csv"), -->
<!--                     sep= ";", check.names = F) %>% -->
<!--   rename(year= 2017, department= prov_ubi) %>% -->
<!--   mutate(country= "Ecuador", -->
<!--          scale= "parroquia") -->
<!-- ``` -->


<!-- ```{r eval= FALSE} -->
<!-- knitr::kable((ecua_17 %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(ecua_17), width = "auto") -->
<!-- ``` -->

<!-- ```{r eval= FALSE} -->
<!-- ecua_21 <- read.csv(here("../Health_data/Ecuador/dados_egressos", "egresos_hospitalarios_2021.csv"), -->
<!--                     sep= ";", check.names = F) %>% -->
<!--   rename(year= 2021, department= prov_ubi) %>% -->
<!--   mutate(country= "Ecuador", -->
<!--          scale= "parroquia") -->

<!-- knitr::kable((ecua_21 %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(ecua_21), width = "auto") -->
<!-- ``` -->



<!-- <!-- ```{r, eval=FALSE} --> -->
<!-- <!-- # test search --> -->
<!-- <!-- unique(ecua_21[,32])[2] # found "nasal' --> -->
<!-- <!-- #check if exact string 'Malaria' exists in conf column --> -->
<!-- <!-- str_detect(ecua_21[,32], fixed('nasal', ignore_case= TRUE)) > 0 --> -->

<!-- <!-- # how many? --> -->
<!-- <!-- # sum(str_detect(ecua_21[,32], fixed('nasal', ignore_case= TRUE))) --> -->
<!-- <!-- # which ones? --> -->
<!-- <!-- # ecua_21[,32][which(str_detect(ecua_21[,32], fixed('nasal', ignore_case= TRUE)))] --> -->

<!-- <!-- # AQUIAQUI: now we see how to detect, find each disease for the columns 33:35 , then pivot longer by count n() --> -->
<!-- <!-- ``` --> -->

<!-- <!-- ### Malaria --> -->

<!-- <!-- ```{r} --> -->
<!-- <!-- unique(diseases$Diseases_name) # Malaria --> -->

<!-- <!-- EC_malaria_21 <- ecua_21 %>% --> -->
<!-- <!--   mutate( --> -->
<!-- <!--     Disease_name = ifelse( --> -->
<!-- <!--       any(c_across(32:35) %>% str_detect(fixed('malaria', ignore_case = TRUE))), --> -->
<!-- <!--       "Malaria", --> -->
<!-- <!--       "other_condition")) ### AQUIAQUIAQUI ita all malaria bad --> -->

<!-- <!--     # with case when attemps that DID NOT WORK --> -->
<!-- <!--     # Disease_name = case_when( --> -->
<!-- <!--     #   any(c_across(32:35) %>% str_detect(fixed('malaria', ignore_case = TRUE))) ~ "malaria", --> -->
<!-- <!--     #   TRUE ~ "other_condition" --> -->
<!-- <!--     # )) --> -->

<!-- <!--   ## OR COLWISE --> -->
<!-- <!-- # mutate(Diseases_name= case_when( --> -->
<!-- <!-- #       cau_cie10 == "malaria" ~ "malaria", --> -->
<!-- <!-- #       causa3 == "malaria" ~ "malaria", --> -->
<!-- <!-- #       cap221rx == 1 | cau221rx == 5 ~ "malaria", --> -->
<!-- <!-- #       TRUE ~ "other_condition" --> -->
<!-- <!-- #     str_detect(ecua_21[,32], fixed('malaria', ignore_case= TRUE) ~ "Malaria" --> -->
<!-- <!-- #   )) --> -->
<!-- <!-- #  --> -->
<!-- <!-- # ecua_21[,32][which(str_detect(ecua_21[,32], fixed('malaria', ignore_case= TRUE)))] --> -->
<!-- <!-- ``` --> -->

<!-- Save tidy dataset, the closer to raw: -->
<!-- ```{r} -->
<!-- EC_full_clean <- data_ecuador -->

<!-- write.csv(EC_full_clean, file=here::here("data","Ecuador_cleaned.csv"), -->
<!--           row.names=FALSE) -->
<!-- ``` -->

<!-- ### Health data prepapartion and treat -->

<!-- Timespan available from `r paste0(range(data_ecuador$year)[1], " to ", range(data_ecuador$year)[2]); paste0("-2017, -2018")`. -->


<!-- Available diseases: -->
<!-- ```{r} -->
<!-- names(data_ecuador)[7:dim(data_ecuador)[2]] -->
<!-- ``` -->
<!-- Data of number of cases/ diseases/ year: -->
<!-- To master with other datasets later -->
<!-- ```{r} -->
<!-- # Ecuador data per year -->
<!-- EC_year <- data_ecuador %>% -->
<!--   pivot_longer(7:dim(data_ecuador)[2], -->
<!--                names_to = "diseases", -->
<!--                values_to = "n_cases") %>% -->
<!--   group_by(year, diseases) %>% -->
<!--   summarise(n_cases= sum(n_cases, na.rm = TRUE)) -->


<!-- Ecuador <- EC_year %>% ungroup() %>% -->
<!--   group_by(diseases) %>% -->
<!--     summarise_at(vars(year), -->
<!--                  list(max = max, min= min)) %>% -->
<!--    mutate(timespan= paste0(min, "- ", max, "-2017, -2018")) %>% -->
<!--   left_join(ecua_19 %>% -->
<!--               dplyr::select(Diseases_name, disease_group, D2) %>% -->
<!--               rename(diseases= Diseases_name), by= "diseases") -->



<!-- EC_year <- EC_year %>% ungroup() %>% -->
<!--     left_join(Ecuador, by= "diseases") %>% -->
<!--     dplyr::select(diseases, year, n_cases, -->
<!--                   disease_group) %>% -->
<!--     arrange(diseases) -->

<!-- master_year <- rbind(master_year, -->
<!--           EC_year %>% -->
<!--   mutate(country= "Ecuador") %>% -->
<!--   dplyr::select(country, everything())) -->


<!-- Ecuador %>% arrange(diseases) %>% -->
<!--   dplyr::select(-min, -max) -->
<!-- ``` -->


<!-- ### Summary EC data treatment -->
<!--   - work with csv spreadsheets available, not 2015 nor 2018 -->
<!--   - template of 2017 and 2020 unmanageable -->
<!--   - doubts on parroquia res and ubi -->
<!--   - doubt in entrance year (anio ingresso) -->
<!--   - doubt level province is state? -->
<!-- ```{r} -->
<!-- # EC_year %>% ungroup() %>% -->
<!-- #   drop_na() %>% -->
<!-- #   dplyr::select(disease_group, year) %>% -->
<!-- #   group_by(disease_group) %>% -->
<!-- #     summarise_at(vars(year), -->
<!-- #                  list(max = max, min= min)) %>% -->
<!-- #    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!-- #   dplyr::select(-min, -max) -->

<!-- control <- rbind(control, -->
<!--   c(country= "Ecuador", scale= "municipality", aggregate(diseases~ disease_group,data= Ecuador, FUN = function(x) paste0(x,collapse = '; '))[1,], -->
<!--   timespan= "2016-2020, not 2017-2018", -->
<!--   Source= "Instituto Nacional de Estadistica y Censos: https://www.ecuadorencifras.gob.ec/camas-y-egresos-hospitalarios/", -->
<!--   Researcher= "Internal", -->
<!--   Contact= ""), -->
<!--   c(country= "", scale= "", aggregate(diseases~ disease_group,data= Ecuador, FUN = function(x) paste0(x,collapse = '; '))[2,], -->
<!--   timespan= "2016-2020, not 2017-2018", -->
<!--   Source= " ", -->
<!--   Researcher= " ", -->
<!--   Contact= " "), -->
<!--   c(country= "", scale= "", aggregate(diseases~ disease_group,data= Ecuador, FUN = function(x) paste0(x,collapse = '; '))[3,], -->
<!--   timespan= "2016-2020, not 2017-2018", -->
<!--   Source= " ", -->
<!--   Researcher= " ", -->
<!--   Contact= " ")) -->
<!-- ``` -->


<!-- ## Guiana FR -->

<!-- Data came per disease, so we load each to then join together. -->
<!-- ```{r} -->
<!-- dir("../Health_data/FRguiana") -->
<!-- ``` -->

<!-- Sample to understand template: Acute bronchitis and bronchiolitis: -->
<!-- ```{r} -->
<!-- bronch_GF <- read_excel(here("../Health_data/FRguiana", "Acute bronchitis and bronchiolitis _GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "acute_bronchitis_bronchiolitis") %>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- knitr::kable((bronch_GF %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(bronch_GF), width = "auto") -->

<!-- ``` -->

<!-- Other diseases: -->


<!-- ## aqui aqui aqui aquiaqui update newer versions -->
<!-- ```{r} -->
<!-- myoc_GF <- read_excel(here("../Health_data/FRguiana", "Acute myocardial infarction_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "acute_myocardial_infarction")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Cerebral infarction: -->

<!-- cerebral_GF <- read_excel(here("../Health_data/FRguiana", "cerebral infarction_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "cerebral_infarction")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Chagas: -->

<!-- chagas_GF <- read_excel(here("../Health_data/FRguiana", "chagas_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "chagas")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Conduction disorders and cardiac arrhythmias: -->

<!-- conduction_GF <- read_excel(here("../Health_data/FRguiana", "Conduction disorders and cardiac arrhythmias _GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "conduction_disorders_cardiac_arrhythmias")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Conjunctivitis and other conjunctival disorders: -->

<!-- conjunctivitis_GF <- read_excel(here("../Health_data/FRguiana", "Conjunctivitis and other conjunctival disorders_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "conjunctival_disorders")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Laryngitis and tracheitis: -->
<!-- laryngitis_GF <- read_excel(here("../Health_data/FRguiana", "laryngitis_tracheitis_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "laryngitis_tracheitis")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Leishmaniasis: -->
<!-- leish_GF <- read_excel(here("../Health_data/FRguiana/originals/outdated_edited_to_template", "leishmaniais_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "leishmaniasis")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Malaria: -->

<!-- malaria_GF <- read_excel(here("../Health_data/FRguiana", "malaria_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "malaria")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Neoplasm of the trachea, bronchi, and lungs: -->
<!-- neoplasm_GF <- read_excel(here("../Health_data/FRguiana", "Neoplasm of the trachea, bronchi, and lungs_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "neoplasm_resp")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Other acute upper respiratory tract infections: -->
<!-- upperresp_GF <- read_excel(here("../Health_data/FRguiana", "Other acute upper respiratory tract infections _GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "other_acute_upper_respiratory_infections")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Other chronic obstructive pulmonary diseases: -->
<!-- chronich_pulmonary_GF <- read_excel(here("../Health_data/FRguiana", "Other chronic obstructive pulmonary diseases_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "other_chronic_obstructive_pulmonary_diseases")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Pharyngitis: -->
<!-- pharyngitis_GF <- read_excel(here("../Health_data/FRguiana", "pharyngitis_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "pharyngitis")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Pneumonia: -->
<!-- pneumonia_GF <- read_excel(here("../Health_data/FRguiana", "pneumonia_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "pneumonia")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Pulmonary embolism: -->
<!-- embolism_GF <- read_excel(here("../Health_data/FRguiana", "Pulmonary embolism_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "pulmonary_embolism")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->

<!-- ### Tonsilitis: -->
<!-- tonsilitis_GF <- read_excel(here("../Health_data/FRguiana", "tonsilitis_GUR_ed.xlsx")) %>% -->
<!--   pivot_longer("2017":"2023", names_to= "year", values_to = "tonsilitis")%>% -->
<!--   rename(municipality= CDPS_LIBELLE) -->
<!-- ``` -->

<!-- #### Join diseases: -->

<!-- ```{r} -->
<!-- data_GF <- bronch_GF %>% -->
<!--   right_join(myoc_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(cerebral_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(chagas_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(conduction_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(conjunctivitis_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(laryngitis_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(leish_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(malaria_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(neoplasm_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(upperresp_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(chronich_pulmonary_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(pharyngitis_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(pneumonia_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(embolism_GF, by= c("municipality", "year")) %>% -->
<!--     right_join(tonsilitis_GF, by= c("municipality", "year")) %>% -->
<!--   mutate(country= "Guiana FR", -->
<!--          department= NA, -->
<!--          scale= "municipality", -->
<!--          year= as.numeric(year)) -->


<!-- knitr::kable((data_GF %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(data_GF), width = "auto") -->
<!-- ``` -->

<!-- #### Get municipality code -->
<!-- Comparing with finest administrative boundaries available for GUF, admin shapes 2 (still lacks fit: Talhuen, Javouhey, Antecum Pata, Cacao, Trois Sauts and Zones hors CDPS) -->
<!-- Q2) are Régina and Kaw the same municipality? its separated on the health data, but named "Régina|Kaw" in spatial -->
<!-- ```{r} -->
<!-- # read countries shapefile -->
<!-- GF_shp <- st_read("../spatial/frguiana/gadm41_GUF_2.shp") -->
<!-- # get codes df -->
<!-- GF_codes <- data.frame(GF_shp) -->

<!-- # Normalize strings in both data frames -->
<!-- GF_codes$NAME_2_normalized <- normalize_string(GF_codes$NAME_2) -->
<!-- data_GF$municipality_normalized <- normalize_string(data_GF$municipality) -->

<!-- # Fuzzy string matching -->
<!-- matches <- stringdist::amatch(data_GF$municipality_normalized, -->
<!--                   GF_codes$NAME_2_normalized, maxDist = 2, method = "osa") -->

<!-- # Create a new column in data_brasil with matching values from ADM1_PCODE in df1 -->
<!-- data_GF$COD <- GF_codes$GID_2[matches] -->

<!-- # test where it did not work: -->
<!-- # View(data_brasil[is.na(data_brasil$COD),]) -->

<!-- # extract to verify manually -->
<!-- unique(data_GF$municipality[is.na(data_GF$COD)]) -->
<!--  # [1] "Talhuen"         "Javouhey" -->
<!--  # [3] "Awala"           "Antecum Pata" -->
<!--  # [5] "Regina"          "Saint Georges" -->
<!--  # [7] "Cacao"           "Kaw" -->
<!--  # [9] "Trois Sauts"     "Zones hors CDPS" -->


<!-- # entry manually for those I found eyely -->
<!-- data_GF$COD[data_GF$municipality== "Awala"] <- GF_codes$GID_2[GF_codes$NAME_2== "Awala-Yalimapo"] -->

<!-- data_GF$COD[data_GF$municipality== "Saint Georges"] <- GF_codes$GID_2[GF_codes$NAME_2== "Saint-Georges (de l'Oyapock)"] -->

<!-- data_GF$COD[data_GF$municipality== "Regina"] <- GF_codes$GID_2[GF_codes$NAME_2== "Régina (-Kaw)"] -->
<!-- ## QUERIE HERE, are these the same? -->
<!-- data_GF$COD[data_GF$municipality== "Kaw"] <- GF_codes$GID_2[GF_codes$NAME_2== "Régina (-Kaw)"] -->

<!-- data_GF <- data_GF %>% -->
<!--   dplyr::select(country, department, COD, -->
<!--   municipality, scale, year, 3:18) -->
<!-- ``` -->

<!-- ### Health data prepapartion and treat -->

<!-- Timespan available from `r paste0(range(data_GF$year)[1], " to ", range(data_GF$year)[2])`. -->

<!-- ```{r} -->
<!-- range(data_GF$year) -->
<!-- # check if necessary to correct any wrong string (unique(data_GF$year)) or class not numeric (class(data_GF$year)) -->
<!-- ``` -->

<!-- Available diseases: -->
<!-- ```{r} -->
<!-- names(data_GF)[7:dim(data_GF)[2]] -->
<!-- ``` -->
<!-- QUERIES: -->

<!-- - Q?) No state/department data indeed? -->
<!-- - No code columns, 2 queries from crossing with spatial data: -->
<!--   - No code fits municipalities of Talhuen, Javouhey, Antecum Pata, Cacao, Trois Sauts and Zones hors CDPS -->
<!--   - Code for Régina and Kaw is spatial data are joined together (named "Régina|Kaw"), indeed the same municipality? -->

<!-- Save tidy dataset, the closer to raw: -->
<!-- ```{r} -->
<!-- GF_full_clean <- data_GF -->

<!-- write.csv(GF_full_clean, file=here::here("data","guianaFR_cleaned.csv"), -->
<!--           row.names=FALSE) -->
<!-- ``` -->

<!-- Data of number of cases/ diseases/ year: -->
<!-- To master with other datasets later -->
<!-- ```{r} -->
<!-- # GuianaFR data per year -->
<!-- GF_year <- data_GF %>% -->
<!--   pivot_longer(7:dim(data_GF)[2], -->
<!--                names_to = "diseases", -->
<!--                values_to = "n_cases") %>% -->
<!--   group_by(year, diseases) %>% -->
<!--   summarise(n_cases= sum(n_cases, na.rm = TRUE)) -->


<!-- GuianaFR <- GF_year %>% ungroup() %>% -->
<!--   group_by(diseases) %>% -->
<!--     summarise_at(vars(year), -->
<!--                  list(max = max, min= min)) %>% -->
<!--   mutate( -->
<!--     timespan = paste0(min, "- ", max), -->
<!--     disease_group = as.factor(case_when( -->
<!--       diseases %in% c("acute_bronchitis_bronchiolitis", "laryngitis_tracheitis", "other_acute_upper_respiratory_infections", "other_chronic_obstructive_pulmonary_diseases", "pharyngitis", "pneumonia", "pulmonary_embolism", "tonsilitis", "neoplasm_resp") ~ "respiratory", -->
<!--       diseases %in% c("conduction_disorders_cardiac_arrhythmias", "conjunctival_disorders", "cerebral_infarction", "acute_myocardial_infarction") ~ "cardiovascular", -->
<!--       diseases %in% c("chagas", "leishmaniasis", "malaria") ~ "zoonotic"))) %>% -->
<!--   mutate( -->
<!--   # zoonosis already standardised -->
<!--    D2= disease_group) -->

<!-- GF_year <- GF_year %>% ungroup() %>% -->
<!--     left_join(GuianaFR, by= "diseases") %>% -->
<!--     dplyr::select(diseases, year, n_cases, -->
<!--                   disease_group) %>% -->
<!--     arrange(diseases) -->

<!-- master_year <- rbind(master_year, -->
<!--           GF_year %>% -->
<!--   mutate(country= "Guiana FR") %>% -->
<!--   dplyr::select(country, everything())) -->


<!-- GuianaFR %>% arrange(diseases) %>% -->
<!--   dplyr::select(-min, -max) -->
<!-- ``` -->


<!-- ### Summary GF data treatment -->
<!--   - absend code (unperfect match from spatial, Q2) -->

<!-- ```{r} -->
<!-- # GF_year %>% ungroup() %>% -->
<!-- #   drop_na() %>% -->
<!-- #   dplyr::select(disease_group, year) %>% -->
<!-- #   group_by(disease_group) %>% -->
<!-- #     summarise_at(vars(year), -->
<!-- #                  list(max = max, min= min)) %>% -->
<!-- #    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!-- #   dplyr::select(-min, -max) -->

<!-- control <- rbind(control, -->
<!--   c(country= "Guiana FR", scale= "municipality", aggregate(diseases~ disease_group,data= GuianaFR, FUN = function(x) paste0(x,collapse = '; '))[1,], -->
<!--   timespan= "2017-2023", -->
<!--   Source= "National database: https://www.health-data-hub.fr/depot", -->
<!--                    Researcher= "Benoît Dethoisy", -->
<!--                    Contact= "bdethoisy@pasteur-cayenne.fr"), -->
<!--   c(country= "", scale= "", aggregate(diseases~ disease_group,data= GuianaFR, FUN = function(x) paste0(x,collapse = '; '))[2,], -->
<!--   timespan= "2017-2023", -->
<!--   Source= " ", -->
<!--                    Researcher= " ", -->
<!--                    Contact= " "), -->
<!--     c(country= "", scale= "", aggregate(diseases~ disease_group,data= GuianaFR, FUN = function(x) paste0(x,collapse = '; '))[3,], -->
<!--   timespan= "2017-2023", -->
<!--   Source= " ", -->
<!--                    Researcher= " ", -->
<!--                    Contact= " ")) -->
<!-- ``` -->


<!-- ## Peru -->

<!-- ```{r} -->
<!-- data_peru <- read_excel(here("../Health_data/Peru/Finais", "Peru_diseases_template_24OCT23_V2.xlsx")) %>% -->
<!--   rename_all(., .funs = tolower) # many names in upper case, tolower them -->


<!-- knitr::kable((data_peru %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(data_peru), width = "auto") -->
<!-- ``` -->

<!-- Organized by department (supposedly state), year and municipality. -->

<!-- Tidying control to standardize: -->
<!-- - Absent COD data, get COD data from adm shapes (code 3) -->
<!-- - District "(blank)" not recognizes (Q) querie) -->
<!-- - rename columns to english -->
<!-- - rename columns translated department -->
<!-- - Q) rename diseases column to remove unecessary info -->
<!-- - build municipality code column (should I? Querie, Q) -->
<!-- - Q) indeed district stands for municipality? -->
<!-- - order state, country+municipality code, municipality name -->
<!-- - "scale" column that stands for scale of data content -->
<!-- - remove date range that was contained in each disease name -->


<!-- #### Get municipality code -->
<!-- ```{r} -->
<!-- # read countries shapefile -->
<!-- PE_shp <- st_read("../spatial/peru/per_admbnda_adm3_ign_20200714.shp") -->
<!-- # get codes df -->
<!-- PE_codes <- data.frame(PE_shp) -->

<!-- # Normalize strings in both data frames -->
<!-- PE_codes$ADM3_ES_normalized <- normalize_string(PE_codes$ADM3_ES) -->
<!-- data_peru$district_normalized <- normalize_string(data_peru$district) -->

<!-- # Fuzzy string matching -->
<!-- matches <- stringdist::amatch(data_peru$district_normalized, -->
<!--                   PE_codes$ADM3_ES_normalized, maxDist = 4, method = "osa") -->

<!-- # Create a new column in data_brasil with matching values from ADM3_PCODE in df1 -->
<!-- data_peru$COD <- PE_codes$ADM3_PCODE[matches] -->

<!-- # test where it did not work: -->
<!-- # View(data_peru[is.na(data_peru$COD),]) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- # names(data_peru) -->
<!-- data_peru <- data_peru %>% -->
<!--   dplyr::select(-district_normalized) %>% -->
<!--   rename(municipality= district) %>% -->
<!--   mutate(scale= "municipality", -->
<!--          country= "Peru") %>% -->
<!--   group_by(department, municipality) %>% -->
<!--   select(country, department, COD, municipality, scale, year, 4:22) -->
<!-- ``` -->


<!-- ### Health data prepapartion and treat -->

<!-- Different motitoring timeranges per disease, but generally, most are available from `r paste0(range(data_peru$year)[1], " to ", range(data_peru$year)[2])`. -->

<!-- ```{r} -->
<!-- range(data_peru$year) -->

<!-- # check if class not numeric (class(data_peru$year)) or if necessary to correct any wrong string (unique(data_peru$year)) -->
<!-- ``` -->

<!-- Available diseases: -->

<!-- ```{r} -->
<!-- names(data_peru)[7:25] -->

<!-- # sub(" .*", "", names(data_peru)[7:25]) -->
<!-- ``` -->

<!-- QUERIES: *For now just ignoring, clean out in next lines* -->

<!--     - Whats the difference between consolidada and individual for Malarias? I could erase all info after space, but then duplicated columns for p_falciparum and p_vivax `r paste0(names(data_peru)[19:20], " and ", names(data_peru)[21:22])` - Q?) Why is that? What to do? -->

<!--     - Also regarding malaria, what happens with monitoring that overlap between individual and consolidada between 2003 and 2008? -->

<!--     - Neoplasm column is logical, rm to avoid confusion: values are `r unique(data_peru$"neoplasm_trachea_bronchi_lung (2000-2019)")`. -->

<!--      - Update data to treat NA as actual 0s from monitoring years (step below). -->

<!-- Now conditional replacement of NA values based on the each ID's year range. Break down the logic: -->

<!--     1) Check Year Range: -->
<!--         - Verify if the year falls within the specified range. If not, assign NA to the value. -->

<!--     2) Replace NA Values: -->
<!--       If the year falls within the specified range: -->
<!--         - Check if the value is NA: If the value is NA, replace it with 0.; If the value is not NA, preserve the original value. -->
<!--       If the year falls outside the specified range: -->
<!--         - Set the value to NA for that particular column. -->


<!-- ```{r} -->
<!-- data_peru <- data_peru %>% -->
<!--   mutate( -->
<!--     # bronchial_emphysema (2002-2019): -->
<!--     bronchial_emphysema = -->
<!--            if_else(year >= 2002 & year <= 2019, -->
<!--                    replace_na(`bronchial_emphysema (2002-2019)`, 0), `bronchial_emphysema (2002-2019)`), -->

<!--     # bronquiolitis_aguda (2002-2019): -->
<!--     bronquiolitis_aguda = -->
<!--       if_else(year >= 2002 & year <= 2019, -->
<!--               replace_na(`bronquiolitis_aguda (2002-2019)`, 0), `bronquiolitis_aguda (2002-2019)`), -->

<!--     # bronquitis_aguda (2002-2019): -->
<!--     bronquitis_aguda = -->
<!--       if_else(year >= 2002 & year <= 2019, -->
<!--               replace_na(`bronquitis_aguda  (2002-2019)`, 0), `bronquitis_aguda  (2002-2019)`), -->

<!--     # chagas  (2000-2019): -->
<!--     chagas = if_else(year >= 2000 & year <= 2019, -->
<!--                      replace_na(`chagas (2000-2019)`, 0), `chagas (2000-2019)`), -->

<!--     # conduction_disorder_...  (2002-2019):: -->
<!--     conduction_disorder_cardiac_arrhythmias = -->
<!--       if_else(year < 2002 | year > 2019, -->
<!--               NA_real_, if_else(is.na(`conduction_disorder_cardiac_arrhythmias (2002-2019)`), 0, `conduction_disorder_cardiac_arrhythmias (2002-2019)`)), -->

<!--     # faringitis (2002-2019): -->
<!--     faringitis = -->
<!--       if_else(year < 2002 | year > 2019, NA_real_, -->
<!--               if_else(is.na(`faringitis (2002-2019)`), -->
<!--                       0,`faringitis (2002-2019)`)), -->

<!--     # hantavirus (2011-2018): -->
<!--     hantavirus = -->
<!--       if_else(year < 2011 | year > 2018, NA_real_, -->
<!--               if_else(is.na(`hantavirus (2011-2018)`), 0, `hantavirus (2011-2018)`)), -->

<!--     # infarto_cerebral (2002-2019): -->
<!--     infarto_cerebral = -->
<!--       if_else(year >= 2002 & year <= 2019, replace_na(`infarto_cerebral (2002-2019)`, 0), -->
<!--               `infarto_cerebral (2002-2019)`), -->

<!--     # laringitis (2002-2019): -->
<!--     laringitis = -->
<!--       if_else(year >= 2002 & year <= 2019, replace_na(`laringitis (2002-2019)`, 0), -->
<!--               `laringitis (2002-2019)`), -->

<!--     # leishmaniasis (2000-2019): -->
<!--     leishmaniasis = -->
<!--       if_else(year >= 2000 & year <= 2019, replace_na(`leishmania (2000-2019)`, 0), -->
<!--               `leishmania (2000-2019)`), -->

<!--     # pneumonia (2002-2019): -->
<!--     pneumonia = -->
<!--       if_else(year >= 2002 & year <= 2019, replace_na(`neumonia (2002-2019)`, 0), -->
<!--               `neumonia (2002-2019)`), -->

<!--     # malaria p_falciparum_consolidada (2000-2008): -->
<!--     p_falciparum_consolidada = -->
<!--       if_else(year >= 2000 & year <= 2008, replace_na(`p_falciparum (file malaria_consolidada 2000-2008)`, 0), -->
<!--               `p_falciparum (file malaria_consolidada 2000-2008)`), -->

<!--     # malaria p_falciparum_individual (2003-2019): -->
<!--     p_falciparum_individual = -->
<!--       if_else(year >= 2003 & year <= 2019, replace_na(`p_falciparum (file malaria_individual 2003-2019)`, 0), -->
<!--               `p_falciparum (file malaria_individual 2003-2019)`), -->

<!--     # malaria p_vivax_consolidada (2000-2008): -->
<!--     p_vivax_consolidada = -->
<!--       if_else(year >= 2000 & year <= 2008, replace_na(`p_vivax (file malaria_consolidada 2000-2008)`, 0), -->
<!--               `p_vivax (file malaria_consolidada 2000-2008)`), -->

<!--     # malaria p_vivax_individual (2003-2019): -->
<!--     p_vivax_individual = -->
<!--       if_else(year >= 2003 & year <= 2019, replace_na(`p_vivax (file malaria_individual 2003-2019)`, 0), -->
<!--               `p_vivax (file malaria_individual 2003-2019)`), -->

<!--     # rickettsia (2002-2019): -->
<!--     rickettsia = -->
<!--       if_else(year >= 2002 & year <= 2019, replace_na(`rickettsia (2002-2019)`, 0), -->
<!--               `rickettsia (2002-2019)`), -->

<!--     # tonsilitis (2002-2019): -->
<!--     tonsilitis = -->
<!--       if_else(year >= 2002 & year <= 2019, replace_na(`tonsilitis (2002-2019)`, 0), -->
<!--               `tonsilitis (2002-2019)`), -->

<!--     # traqueitis (2002-2019): -->
<!--     traqueitis = -->
<!--       if_else(year >= 2002 & year <= 2019, replace_na(`traqueitis (2002-2019)`, 0), -->
<!--               `traqueitis (2002-2019)`)) %>% -->
<!--   dplyr::select(-`bronchial_emphysema (2002-2019)`, -->
<!--          -`bronquiolitis_aguda (2002-2019)`, -->
<!--          -`bronquitis_aguda  (2002-2019)`, -->
<!--          -`chagas (2000-2019)`, -->
<!--          -`conduction_disorder_cardiac_arrhythmias (2002-2019)`, -->
<!--          -`faringitis (2002-2019)`, -->
<!--          -`hantavirus (2011-2018)`, -->
<!--          -`infarto_cerebral (2002-2019)`, -->
<!--          -`laringitis (2002-2019)`, -->
<!--          -`leishmania (2000-2019)`, -->
<!--          - `neoplasm_trachea_bronchi_lung (2000-2019)`, -->
<!--          -`neumonia (2002-2019)`, -->
<!--          -`p_falciparum (file malaria_consolidada 2000-2008)`, -->
<!--          -`p_falciparum (file malaria_individual 2003-2019)`, -->
<!--          -`p_vivax (file malaria_consolidada 2000-2008)`, -->
<!--          -`p_vivax (file malaria_individual 2003-2019)`, -->
<!--          -`rickettsia (2002-2019)`, -->
<!--          -`tonsilitis (2002-2019)`, -->
<!--          -`traqueitis (2002-2019)`) -->
<!-- ``` -->


<!-- Save tidy dataset, the closer to raw: -->
<!-- ```{r} -->
<!-- PE_full_clean <- data_peru -->

<!-- write.csv(PE_full_clean, file=here::here("data","peru_cleaned.csv"), -->
<!--           row.names=FALSE) -->
<!-- ``` -->

<!-- - Besides group them broadly by fire related diseases ("bronchial_emphysema", "bronquiolitis_aguda", "bronquitis_aguda", "conduction_disorder_cardiac_arrhythmias", "faringitis", "infarto_cerebral", "laringitis", "neoplasm_trachea_bronchi_lung", "neumonia", "tonsilitis", "traqueitis"); and zoonotic diseases ("chagas", "hantavirus", "leishmania", "p_falciparum", "p_falciparum", "p_vivax", "p_vivax", "rickettsia") -->

<!-- Data of number of cases/ diseases/ year: -->
<!-- To master with other datasets later -->
<!-- ```{r} -->

<!-- PE_year <- data_peru %>% -->
<!--   pivot_longer(7:dim(data_peru)[2], -->
<!--                names_to = "diseases", -->
<!--                values_to = "n_cases") %>% -->
<!--   # mutate(n_cases= as.numeric(n_cases)) %>% -->
<!--   group_by(year, diseases) %>% -->
<!--   summarise(n_cases= sum(n_cases, na.rm = TRUE)) -->


<!-- Peru <- PE_year %>% -->
<!--   # to get actual timespan, remove zeros because folloqing disease information, we see they're NAs -->
<!--   filter(n_cases>0) %>% -->
<!--   ungroup() %>% -->
<!--   group_by(diseases) %>% -->
<!--     summarise_at(vars(year), -->
<!--                  list(max = max, min= min)) %>% -->
<!--    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!--    # Disease broad grouping F-R vs zoonotic diseases -->
<!--   mutate( -->
<!--   disease_group = as.factor(case_when( -->
<!--     diseases %in% c("bronchial_emphysema", "bronquiolitis_aguda", "bronquitis_aguda", "faringitis", "laringitis", "pneumonia", "tonsilitis", "traqueitis") ~ "respiratory", -->
<!--     diseases %in% c("conduction_disorder_cardiac_arrhythmias", "infarto_cerebral", "neoplasm_trachea_bronchi_lung") ~ "cardiovascular", -->
<!--     diseases %in% c("chagas", "hantavirus", "leishmaniasis", "p_falciparum_consolidada", "p_falciparum_individual", "p_vivax_consolidada", "p_vivax_individual", "rickettsia") ~ "zoonotic" -->
<!--   )), -->
<!--    # matching diseases, as D2 from diseases list -->
<!--   D2 = case_when( -->
<!--     diseases %in% c("p_falciparum_consolidada", "p_falciparum_individual", "p_vivax_consolidada", "p_vivax_individual") ~ "malaria", -->
<!--     diseases == "hantavirus" ~ "hantavirus", -->
<!--     diseases == "leishmaniasis" ~ "leishmaniasis", -->
<!--     diseases == "rickettsia" ~ "rickettsia", -->
<!--     diseases == "chagas" ~ "chagas", -->
<!--     TRUE ~ disease_group)) -->

<!-- PE_year <- PE_year %>% ungroup() %>% -->
<!--     left_join(Peru, by= "diseases") %>% -->
<!--     dplyr::select(diseases, year, n_cases, -->
<!--                   disease_group) %>% -->
<!--     arrange(diseases) %>% -->
<!--     drop_na() -->

<!-- master_year <- rbind(master_year, -->
<!--           PE_year %>% -->
<!--   mutate(country= "Peru") %>% -->
<!--   dplyr::select(country, everything())) -->


<!-- Peru %>% arrange(diseases) %>% -->
<!--   dplyr::select(-min, -max) -->
<!-- ``` -->


<!-- ### Summary PE data treatment -->

<!--     - Coerce 0 into NAs for years after monitoring started -->
<!--     - remove disease thet is not numerical (neoplasm) -->
<!--     - Understand the difference between comalarias, and if monitoring years indeed overlap/are not redundant -->

<!-- ```{r} -->
<!-- # PE_year %>% ungroup() %>% -->
<!-- #   drop_na() %>% -->
<!-- #   dplyr::select(disease_group, year) %>% -->
<!-- #   group_by(disease_group) %>% -->
<!-- #     summarise_at(vars(year), -->
<!-- #                  list(max = max, min= min)) %>% -->
<!-- #    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!-- #   dplyr::select(-min, -max) -->

<!-- control <- rbind(control, -->
<!--   c(country= "Peru", scale= "municipality", aggregate(diseases~ disease_group,data= Peru, FUN = function(x) paste0(x,collapse = '; '))[1,], -->
<!--   timespan= "2000-2019", -->
<!--   Source= "https://www.minsa.gob.pe/reunis/ -->
<!-- https://www.inei.gob.pe/estadisticas/indice-tematico/health/ -->
<!-- https://www.dge.gob.pe/portalnuevo/ -->
<!-- https://www.dge.gob.pe/portalnuevo/informacion-publica/casos-de-incidencias-acumuladas/ -->
<!-- https://www.dge.gob.pe/portalnuevo/informacion-publica/casos-de-incidencias-acumuladas/ -->
<!-- ", Researcher= "Farah Carrasco", -->
<!--             Contact= "farahcarrasco@gmail.com"), -->
<!--   c(country= "", scale= "", aggregate(diseases~ disease_group,data= Peru, FUN = function(x) paste0(x,collapse = '; '))[2,], -->
<!--   timespan= "2000-2019", -->
<!--   Source= " ", -->
<!--   Researcher= " ", -->
<!--   Contact= " "), -->
<!-- c(country= "", scale= "", aggregate(diseases~ disease_group,data= Peru, FUN = function(x) paste0(x,collapse = '; '))[3,], -->
<!--   timespan= "2000-2019", -->
<!--   Source= " ", -->
<!--   Researcher= " ", -->
<!--   Contact= " ")) -->
<!-- ``` -->


<!-- ## Suriname -->

<!-- In Suriname, Victoria collected data for Leishmaniasis, Malaria,	Upper and Lower respiratory tract infections. The territorial organization is composed of regions, *Q)* which is not one of the subdivisions we have available on the adm shapefile. We have country at level 0, then districts ate level 1, no intermediary region level. No data for NA. -->

<!-- Source data comes from the national data on communicable diseases among indigenous and maroon communities, living in rural- and remote Suriname, that was available digitally between 2000 and 2019. This data is from the Medical Mission, a regional primary healthcare provider, that works in rural- and remote areas of the country. Data on other diseases that you've requested are stored on paper at various hospitals in the north-coastal area of Suriname. These are very hard and time-consuming to access and require permission from the Ministry of Health, thus it was not feasible for this project. -->

<!-- *Victoria about fire and wind wise:* In regards to forest fires in Brazil, I doubt that they have had an effect on the indigenous and maroon communities in Suriname, as we have the northeast trade wind blowing over our country. -->


<!-- ```{r} -->
<!-- data_suriname <- -->
<!--   read_excel(here("../Health_data/Suriname", "Data Communicable diseases_Suriname_VMorpurgo.xlsx")) %>% -->
<!--   drop_na() %>% -->
<!--   # Leishmaniasis is as chr bc of is.na == "No data" -->
<!--   mutate(Leishmaniasis= as.numeric( -->
<!--     ifelse(Leishmaniasis=="No data", NA, Leishmaniasis))) -->

<!-- knitr::kable((data_suriname %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(data_suriname), width = "auto") -->
<!-- ``` -->

<!-- Tidying to standardize: -->
<!-- - (Q) QQuerie how to cross spatial data, regions above the mapped level of district -->
<!-- - rename columns to region -->
<!-- - build code column following that level of analysys (should I? Querie) -->
<!-- ```{r} -->
<!-- data_suriname <- data_suriname %>% -->
<!--   rename(region = "MZ Region", -->
<!--          year= Year) %>% -->
<!--   mutate(scale= "region", -->
<!--          country= "Suriname") %>% -->
<!--   group_by(region) %>% -->
<!--   mutate(COD= paste0("SU", cur_group_id())) %>% -->
<!--   # mutate_at(3:6, ~replace_na(.x, 0)) %>% -->
<!--   select(country, region, COD, scale, year, everything()) -->
<!-- ``` -->

<!-- ### Health data prepapartion and treat -->

<!-- Timespan available from `r paste0(range(data_suriname$year)[1], " to ", range(data_suriname$year)[2])`. -->

<!-- ```{r} -->
<!-- range(data_suriname$year) -->
<!-- # check if necessary to correct any wrong string (unique(data_suriname$year)) or class not numeric (class(data_suriname$year)) -->
<!-- ``` -->

<!-- Available diseases: -->

<!-- ```{r} -->
<!-- names(data_suriname)[6:9] -->
<!-- ``` -->
<!-- DECISIONS: -->
<!-- - find if cod make sense with spatial data -->


<!-- Save tidy dataset, the closer to raw: -->
<!-- ```{r} -->
<!-- SU_full_clean <- data_suriname -->

<!-- write.csv(SU_full_clean, file=here::here("data","suriname_cleaned.csv"), -->
<!--           row.names=FALSE) -->
<!-- ``` -->

<!-- - Besides group them broadly by fire related and zoonotic diseases -->

<!-- Data of number of cases/ diseases/ year: -->
<!-- To master with other datasets later -->
<!-- ```{r} -->
<!-- # Suriname data per year -->
<!-- SU_year <- data_suriname %>% -->
<!--   pivot_longer(6:dim(data_suriname)[2], -->
<!--                names_to = "diseases", -->
<!--                values_to = "n_cases") %>% -->
<!--   # to match Diseases from list -->
<!--   mutate(diseases= tolower(diseases)) %>% -->
<!--   group_by(year, diseases) %>% -->
<!--   summarise(n_cases= sum(n_cases, na.rm = TRUE)) -->


<!-- Suriname <- SU_year %>% ungroup() %>% -->
<!--   # remove zeros -->
<!--   filter(!is.na(n_cases)) %>% -->
<!--   group_by(diseases) %>% -->
<!--     summarise_at(vars(year), -->
<!--                  list(max = max, min= min)) %>% -->
<!--    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!--    # Disease broad grouping F-R vs zoonotic diseases -->
<!--     mutate(disease_group= as.factor(case_when( -->
<!--     diseases %in% c("upper respiratory tract infections", "lower respiratory tract infections") ~ "respiratory", -->
<!--     diseases %in% c("leishmaniasis", "malaria") ~ "zoonotic")), -->
<!--     D2= case_when(disease_group== "zoonotic" ~ diseases, TRUE~ disease_group)) -->

<!-- SU_year <- SU_year %>% ungroup() %>% -->
<!--     left_join(Suriname, by= "diseases") %>% -->
<!--     dplyr::select(diseases, year, n_cases, -->
<!--                   disease_group) %>% -->
<!--     arrange(diseases) -->

<!-- master_year <- rbind(master_year, -->
<!--           SU_year %>% -->
<!--   mutate(country= "Suriname") %>% -->
<!--   dplyr::select(country, everything())) -->


<!-- Suriname %>% arrange(diseases) %>% -->
<!--   dplyr::select(-min, -max) -->
<!-- ``` -->


<!-- ### Summary SU data treatment -->
<!--   - Remone Leishmaniasis which is all NA data -->
<!--   - Understand level of analysis and if talk to spatial -->

<!-- ```{r} -->
<!-- # SU_year %>% ungroup() %>% -->
<!-- #   drop_na() %>% -->
<!-- #   dplyr::select(disease_group, year) %>% -->
<!-- #   group_by(disease_group) %>% -->
<!-- #     summarise_at(vars(year), -->
<!-- #                  list(max = max, min= min)) %>% -->
<!-- #    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!-- #   dplyr::select(-min, -max) -->

<!-- control <- rbind(control, -->
<!--   c(country= "Suriname", scale= "municipality", aggregate(diseases~ disease_group,data= Suriname, FUN = function(x) paste0(x,collapse = '; '))[1,], -->
<!--   timespan= "2000-2019", -->
<!--   Source= "Medical mission (healthcare provider): https://www.medischezending.sr", -->
<!--   Researcher= "Victoria Morpurgo", -->
<!--   Contact= "victoria.morpurgo@gmail.com"), -->
<!--   c(country= "", scale= "", aggregate(diseases~ disease_group,data= Suriname, FUN = function(x) paste0(x,collapse = '; '))[2,], -->
<!--   timespan= "2000-2019", -->
<!--   Source= " ", -->
<!--   Researcher= " ", -->
<!--   Contact= " ")) -->
<!-- ``` -->

<!-- ## Venezuela -->

<!-- In Venezuela, the territorial organization is composed of departments, which are divided into municipalities, which are further subdivided into 'parishes.'paróquias'. Only two Venezuelan departments within Amazonian domain, just one had data: Bolivar. Only Malaria data is presented and for each 'paróquia', the smaller administrative unit within a municipality. -->


<!-- ```{r} -->
<!-- data_venezuela <- -->
<!--   read_excel(here("../Health_data/Venezuela", "Malaria_venezuela_edo_bolivar.xlsx")) %>% -->
<!--   rename_all(., .funs = tolower) -->

<!-- knitr::kable((data_venezuela %>% -->
<!--   sample_n(20, replace = FALSE)), booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(data_venezuela), width = "auto") -->
<!-- ``` -->

<!-- Organized by parroquia, lower level than district/municipality. One department only (state), which is Bolivar. -->

<!-- Tidying to standardize: -->
<!-- - rename columns to english -->
<!-- - rename columns department to state -->
<!-- - Q) rename diseases column to remove unecessary info -->
<!-- - build parroquia code column (that should match ADM3) -->
<!-- - order state, country+municipality code, municipality name -->
<!-- - "scale" column that stands for scale of data content -->

<!-- ```{r} -->
<!-- data_venezuela <- data_venezuela %>% -->
<!--   rename(municipality= municipio) %>% -->
<!--   # rename_all(sub(" .*", "", names(.))) %>% -->
<!--   mutate(department= "Bolivar", -->
<!--          scale= "parroquia", -->
<!--          country= "Venezuela") %>% -->
<!--   group_by(department, municipality, parroquia) %>% -->
<!--   mutate( -->
<!--     # add 0, besides VE, to match spatial data: -->
<!--     COD = paste0("VE0", coddpt)) %>% -->
<!--   pivot_wider(names_from = plasmodium, names_prefix = "malaria_p", values_from = `incidence(n)`) %>% -->
<!--   select(country, department, COD, municipality, parroquia, scale, year, malaria_pVivax, malaria_pFalci) -->
<!-- ``` -->

<!-- ### Health data prepapartion and treat -->

<!-- Timespan available from `r paste0(range(data_venezuela$year)[1], " to ", range(data_venezuela$year)[2])`. -->

<!-- ```{r} -->
<!-- range(data_venezuela$year) -->

<!-- # check if class not numeric (class(data_venezuela$year)) or if necessary to correct any wrong string (unique(data_venezuela$year)) -->
<!-- ``` -->

<!-- Available diseases: Malaria only, for plasmodium Vivax and Falciparum. -->


<!-- Save tidy dataset, the closer to raw: -->
<!-- ```{r} -->
<!-- VE_full_clean <- data_venezuela -->

<!-- write.csv(VE_full_clean, file=here::here("data","venezuela_cleaned.csv"), -->
<!--           row.names=FALSE) -->
<!-- ``` -->

<!-- Data of number of cases/ diseases/ year: -->
<!-- To master with other datasets later -->
<!-- ```{r} -->
<!-- # Venezuela data per year -->
<!-- VE_year <- data_venezuela %>% -->
<!--   pivot_longer(8:dim(data_venezuela)[2], -->
<!--                names_to = "diseases", -->
<!--                values_to = "n_cases") %>% -->
<!--   group_by(year, diseases) %>% -->
<!--   summarise(n_cases= sum(n_cases, na.rm = TRUE)) -->


<!-- Venezuela <- VE_year %>% ungroup() %>% -->
<!--   group_by(diseases) %>% -->
<!--     summarise_at(vars(year), -->
<!--                  list(max = max, min= min)) %>% -->
<!--    mutate(timespan= paste0(min, "- ", max), -->
<!--     # Disease broad grouping F-R vs zoonotic diseases -->
<!--        disease_group= "zoonotic", -->
<!--           D2= "malaria") -->

<!-- VE_year <- VE_year %>% ungroup() %>% -->
<!--     left_join(Venezuela, by= "diseases") %>% -->
<!--     dplyr::select(diseases, year, n_cases, -->
<!--                   disease_group) %>% -->
<!--     arrange(diseases) %>% -->
<!--     drop_na() -->

<!-- master_year <- rbind(master_year, -->
<!--           VE_year %>% -->
<!--   mutate(country= "Venezuela") %>% -->
<!--   dplyr::select(country, everything())) -->

<!-- write.csv(master_year, file=here::here("data","master_year.csv"), -->
<!--           row.names=FALSE) -->

<!-- Venezuela %>% arrange(diseases) %>% -->
<!--   dplyr::select(-min, -max) -->
<!-- ``` -->


<!-- ### Summary VE data treatment -->
<!--   - Coerce na into zeros -->
<!--   - no department columns, only at the scale of analysis level= municipality -->
<!--   - No fire-related data -->
<!--   - Pending to relate names with original given list ("Chagas disease", "Hantavirus", "Leishmaniasis Visceral", "Cutaneous Leishmaniasis", "Malaria") -->

<!-- ```{r} -->
<!-- # VE_year %>% ungroup() %>% -->
<!-- #   drop_na() %>% -->
<!-- #   dplyr::select(disease_group, year) %>% -->
<!-- #   group_by(disease_group) %>% -->
<!-- #     summarise_at(vars(year), -->
<!-- #                  list(max = max, min= min)) %>% -->
<!-- #    mutate(timespan= paste0(min, "- ", max)) %>% -->
<!-- #   dplyr::select(-min, -max) -->

<!-- control <- rbind(control, -->
<!--   c(country= "Venezuela", scale= "parroquia", aggregate(diseases~ disease_group,data= Venezuela, FUN = function(x) paste0(x,collapse = '; ')), -->
<!--   timespan= "1995-2017", -->
<!--   Source= "http://factor.prodavinci.com/escalademalaria/index.html -->
<!-- http://factor.prodavinci.com/cazadoresdevirusenVenezuela/index.html", -->
<!-- Researcher= "Adrian Gonzales/Helena Carpio", -->
<!--             Contact= "adgonzalez86@gmail.com")) -->
<!-- ``` -->



<!-- # Master data control -->
<!-- ```{r} -->
<!-- knitr::kable(control, booktabs = TRUE) %>% -->
<!--   kable_styling(latex_options = "scale_down") %>% -->
<!--   column_spec(1:ncol(control), width = "auto") -->
<!-- ``` -->



<!-- <!-- AQUIAQUIAQUI ONLY SFTER STANDARDIZE NAMES --> -->
<!-- <!-- Control spreadsheet containing available disease data per country, scale of information and year. Columns: country, scale, disease, year, n_cases. --> -->

<!-- <!-- ```{r} --> -->
<!-- <!-- data_main <- data_bolivia %>% --> -->
<!-- <!--   select(-department, -COD, -municipality) %>% --> -->
<!-- <!--   pivot_longer(4:11, names_to = "disease", values_to = "n_cases") %>% --> -->
<!-- <!--   group_by(country, scale, disease, year) %>% summarise_all(sum) --> -->
<!-- <!-- ``` --> -->

<!-- # Exploratory plots -->

<!-- doenças, pais e ano, repetindo quantos dados tiver -->

<!-- ## Year range -->
<!-- ```{r eval=FALSE} -->
<!-- master_year$country <-factor(master_year$country, levels = sort(unique(master_year$country))) -->
<!-- ``` -->


<!-- ```{r eval=FALSE} -->
<!-- ggplot(master_year, -->
<!--        aes(x = year, y = country, color = disease_group, group = country)) + -->
<!--     geom_point() + -->
<!--     geom_line() + -->
<!--     facet_wrap(~ disease_group, scales = "free") + # make scales free if needed -->
<!--     labs(y = "Country", x = "Year") + -->
<!--     guides(x = guide_axis(angle = 80)) + -->
<!--     theme(legend.position = "none", -->
<!--           legend.title = element_blank()) -->



<!--   #   # ggtitle("EXAMPLE") #/ -->
<!--   # # # OR -->
<!--   # ggplot(master_year, aes(x=year,y=country, col=disease_group))+ -->
<!--   #   geom_point() + geom_line() + -->
<!--   #   scale_color_manual( -->
<!--   #     values=c('#990000','#FF9933','#006633')) + -->
<!--   #   labs(y= "Country", x= "Year") + -->
<!--   #   guides(x =  guide_axis(angle = 50)) + -->
<!--   #   theme(legend.position="top", -->
<!--   #         legend.title = element_blank()) -->
<!-- ``` -->

<!-- ```{r echo= FALSE, fig.height=10, fig.width=12} -->
<!-- zoo <- ggplot(master_year %>% -->
<!--                filter(disease_group == "zoonotic"), -->
<!--              aes(x = factor(year), y = fct_rev(country), group = country)) + -->
<!--   geom_point(color = '#006633') + -->
<!--   geom_line(color = '#006633') + -->
<!--   labs(y = "Country", x = "Year", -->
<!--        title= "Zoonotic diseases") + -->
<!--   guides(x = guide_axis(angle = 80)) + -->
<!--   scale_y_discrete(drop = FALSE) -->

<!-- cardiovasc <- ggplot(master_year %>% -->
<!--                        filter(disease_group == "cardiovascular"), -->
<!--        aes(x = factor(year), y = fct_rev(country), group = country)) + -->
<!--   geom_point(color = '#990000') + -->
<!--   geom_line(color = '#990000') + -->
<!--   labs(y = "Country", x = "Year", -->
<!--        title= "Cardiovascular (fire-related)") + -->
<!--   guides(x = guide_axis(angle = 80)) + -->
<!--   scale_y_discrete(drop = FALSE)  # Ensure all countries are included in the y-axis scale -->


<!-- resp <- ggplot(master_year %>% -->
<!--                  filter(disease_group == "respiratory"), -->
<!--              aes(x = factor(year), y = fct_rev(country), group = country)) + -->
<!--   geom_point(color = '#FF9933') + -->
<!--   geom_line(color = '#FF9933') + -->
<!--   labs(y = "Country", x = "Year", -->
<!--        title= "Respiratory (fire-related)") + -->
<!--   guides(x = guide_axis(angle = 80)) + -->
<!--   scale_y_discrete(drop = FALSE) -->

<!-- zoo/(cardiovasc + resp) -->


<!-- ggsave("figures/diseases_countires_yr.png", height= 7, width=10) -->
<!-- ``` -->

<!-- ## Disease groups per country -->

<!-- Bolivia: -->
<!-- ```{r} -->
<!-- bo_plot <- ggplot(master_year %>% -->
<!--                     filter(country == "Bolivia"), -->
<!--        aes(x = year, y = n_cases, -->
<!--            fill = disease_group)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs(y = "Total # of Cases", x = "Year") + -->
<!--   scale_fill_manual(values = c('#990000','#FF9933','#006633')) + -->
<!--   theme(legend.position = "none", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + -->
<!--   ggtitle('Bolivia') -->

<!-- bo_plot + theme(legend.position = "top", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + ggtitle(' ') -->

<!-- ggsave("figures/BO_groups_yrs.png", height= 5, width=7) -->

<!-- ``` -->

<!-- Brasil: -->
<!-- ```{r fig.width= 4, fig.height= 3} -->
<!-- br_plot <- ggplot(master_year %>% filter(country == "Brasil"), -->
<!--        aes(x = year, y = n_cases, fill = disease_group)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs(y = "Total # of Cases", x = "Year") + -->
<!--   scale_fill_manual(values = c('#990000','#FF9933','#006633')) + -->
<!--   theme(legend.position = "none", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + -->
<!--   ggtitle('Brasil') -->


<!-- br_plot + theme(legend.position = "top", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + ggtitle(' ') -->

<!-- ggsave("figures/BR_groups_yrs.png", height= 5, width=7) -->
<!-- ``` -->

<!-- Colombia: -->
<!-- ```{r} -->
<!-- co_plot <- ggplot(master_year %>% -->
<!--                     filter(country == "Colombia"), -->
<!--        aes(x = year, y = n_cases, -->
<!--            fill = disease_group)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs(y = "Total # of Cases", x = "Year") + -->
<!--   scale_fill_manual(values = c('#990000','#FF9933','#006633')) + -->
<!--   theme(legend.position = "none", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + -->
<!--   ggtitle('Colombia') -->

<!-- co_plot + theme(legend.position = "top", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + ggtitle(' ') -->

<!-- ggsave("figures/CO_groups_yrs.png", height= 5, width=7) -->

<!-- ``` -->

<!-- Ecuador: -->
<!-- ```{r} -->
<!-- ec_plot <- ggplot(master_year %>% -->
<!--                     filter(country == "Ecuador"), -->
<!--        aes(x = year, y = n_cases, -->
<!--            fill = disease_group)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs(y = "Total # of Cases", x = "Year") + -->
<!--   scale_fill_manual(values = c('#990000','#FF9933','#006633')) + -->
<!--   theme(legend.position = "none", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + -->
<!--   ggtitle('Ecuador') -->

<!-- ec_plot + theme(legend.position = "top", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + ggtitle(' ') -->

<!-- ggsave("figures/EC_groups_yrs.png", height= 5, width=7) -->

<!-- ``` -->

<!-- Guiana FR: -->
<!-- ```{r} -->
<!-- gf_plot <- ggplot(master_year %>% -->
<!--          filter(country == "Guiana FR"), -->
<!--        aes(x = year, y = n_cases, -->
<!--            fill = disease_group)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs(y = "Total # of Cases", x = "Year") + -->
<!--   scale_fill_manual(values = c('#990000','#FF9933','#006633')) + -->
<!--   # scale_x_continuous(breaks = seq(min(master_year$year), max(master_year$year), by = 1)) + -->
<!--   theme(legend.position = "none", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + -->
<!--   ggtitle('Guiana FR') -->

<!-- gf_plot + theme(legend.position = "top", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + ggtitle(' ') -->

<!-- ggsave("figures/GF_groups_yrs.png", height= 5, width=7) -->

<!-- ``` -->

<!-- Peru: -->
<!-- ```{r} -->
<!-- pe_plot <- ggplot(master_year %>% -->
<!--                     filter(country == "Peru"), -->
<!--        aes(x = year, y = n_cases, -->
<!--            fill = disease_group)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs(y = "Total # of Cases", x = "Year") + -->
<!--   scale_fill_manual(values = c('#990000','#FF9933','#006633')) + -->
<!--   theme(legend.position = "none", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + -->
<!--   ggtitle('Peru') -->

<!-- pe_plot + theme(legend.position = "top", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + ggtitle(' ') -->

<!-- ggsave("figures/PE_groups_yrs.png", height= 5, width=7) -->

<!-- ``` -->

<!-- Suriname: -->
<!-- ```{r} -->
<!-- su_plot <- ggplot(master_year %>% -->
<!--                     filter(country == "Suriname"), -->
<!--        aes(x = year, y = n_cases, -->
<!--            fill = disease_group)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs(y = "Total # of Cases", x = "Year") + -->
<!--   scale_fill_manual(values = c('#FF9933','#006633')) + -->
<!--   theme(legend.position = "none", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + -->
<!--   ggtitle('Suriname') -->

<!-- su_plot + theme(legend.position = "top", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + ggtitle(' ') -->

<!-- ggsave("figures/SU_groups_yrs.png", height= 5, width=7) -->
<!-- ``` -->

<!-- Venezuela: -->
<!-- ```{r} -->
<!-- ve_plot <- ggplot(master_year %>% filter(country == "Venezuela"), -->
<!--        aes(x = year, y = n_cases, fill = disease_group)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs(y = "Total # of Cases", x = "Year") + -->
<!--   scale_fill_manual(values = c('#006633'), labels= c("Malarias")) + -->
<!--   theme(legend.position = "none", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + -->
<!--   ggtitle('Venezuela') -->

<!-- ve_plot + theme(legend.position = "top", -->
<!--         legend.title = element_blank(), -->
<!--         axis.text.x = element_text(angle = 75, hjust = 1)) + ggtitle(' ') -->

<!-- ggsave("figures/VE_groups_yrs.png", height= 5, width=7) -->

<!-- ``` -->

<!-- ### Groups (full panel) -->
<!-- ```{r fig.height=10, fig.width=12} -->
<!-- (bo_plot + br_plot + co_plot) / -->
<!--   (ec_plot + plot_spacer() + gf_plot) / -->
<!--   (pe_plot + su_plot + ve_plot) -->

<!-- ggsave("figures/countries_groups_yrs.png", height= 14, width=14) -->
<!-- ``` -->


<!-- ## Number of diseases -->
<!-- Dataset that count the number od IDs per group, per country. -->

<!-- ```{r} -->
<!-- (n_dis <- master_year %>% -->
<!--          group_by(country, disease_group) %>% -->
<!--   distinct(diseases) %>% -->
<!--          summarize(n_diseases = n())) -->
<!-- ``` -->


<!-- ```{r fig.height= 6, fig.width= 6} -->
<!-- ggplot(n_dis %>% -->
<!--          filter(disease_group != "fire-related"), -->
<!--        aes(x = fct_rev(country), y = n_diseases, fill = disease_group)) + -->
<!--   geom_bar(stat = "identity") + -->
<!--   geom_text(aes(label = n_diseases), -->
<!--             position = position_stack(vjust = 0.5),  # Adjusting the position -->
<!--             size = 3, -->
<!--             color = "white") +  # Adding text labels with the counts -->
<!--   coord_flip() + -->
<!--   scale_fill_manual(values = c('#990000', '#FF9933', '#006633')) + -->
<!--   labs(title = "Count of IDs by Country", -->
<!--        x = " ", -->
<!--        y = "Count", -->
<!--        fill = "ID's group") + -->
<!--   theme(legend.position = c(0.95, 0.05),  # Adjusting legend position -->
<!--         legend.justification = c("right", "bottom"),  # Adjusting justification -->
<!--         legend.box.just = "right") -->
<!-- ggsave("figures/ndiseases_groups.png", height= 5, width=6) -->
<!-- ``` -->

